<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–¢–ï–ö Simulator v4</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #0f1318;
            --bg-panel: #161b22;
            --bg-card: #1c2128;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-cyan: #39c5cf;
            --neon-green: #00ff88;
            --status-green: #3fb950;
            --status-yellow: #d29922;
            --status-orange: #db6d28;
            --status-red: #f85149;
            --status-purple: #a371f7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* HEADER */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .logo {
            font-weight: 700;
            font-size: 0.9rem;
            background: linear-gradient(90deg, var(--accent-cyan), var(--neon-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-stats { display: flex; gap: 10px; align-items: center; }
        .stat-pill {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 4px 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.65rem;
        }
        .stat-pill.danger { border-color: var(--status-red); animation: glow 1s infinite; }
        @keyframes glow {
            0%,100% { box-shadow: 0 0 5px rgba(248,81,73,0.3); }
            50% { box-shadow: 0 0 15px rgba(248,81,73,0.6); }
        }
        .stat-label { color: var(--text-muted); font-size: 0.55rem; }
        .stat-value { font-weight: 700; }
        .green { color: var(--status-green); }
        .yellow { color: var(--status-yellow); }
        .red { color: var(--status-red); }
        .cyan { color: var(--accent-cyan); }
        .gold { color: #ffd700; }
        .mini-bar { width: 50px; height: 4px; background: var(--bg-primary); border-radius: 2px; overflow: hidden; }
        .mini-bar-fill { height: 100%; transition: all 0.3s; }
        .btn-sm {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.6rem;
        }
        .btn-sm:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }

        /* MAIN LAYOUT */
        .main-layout {
            flex: 1;
            display: grid;
            grid-template-columns: 180px 1fr 200px;
            grid-template-rows: 55% 45%;
            gap: 6px;
            padding: 6px;
            overflow: hidden;
        }

        /* LEFT PANEL */
        .left-panel {
            grid-row: 1 / 3;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-header {
            background: var(--bg-panel);
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .units-section { padding: 6px; border-bottom: 1px solid var(--border); }
        .unit-row {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px;
            background: var(--bg-card);
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 0.55rem;
        }
        .unit-icon { font-size: 14px; }
        .unit-info { flex: 1; }
        .unit-name { color: var(--text-primary); font-weight: 600; }
        .unit-level { color: var(--accent-cyan); font-size: 0.5rem; }
        .events-section { flex: 1; overflow-y: auto; padding: 6px; }
        .event-item {
            background: var(--bg-card);
            padding: 5px 6px;
            border-radius: 3px;
            border-left: 2px solid var(--border);
            margin-bottom: 3px;
            font-size: 0.5rem;
        }
        .event-item.alert { border-left-color: var(--status-red); }
        .event-item.warning { border-left-color: var(--status-yellow); }
        .event-item.success { border-left-color: var(--status-green); }
        .event-item.info { border-left-color: var(--accent-cyan); }
        .event-time { color: var(--text-muted); }
        .event-text { color: var(--text-secondary); margin-top: 1px; }

        /* MAP SECTION */
        .map-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        .map-header {
            position: absolute;
            top: 0; left: 0; right: 0;
            background: rgba(15,19,24,0.9);
            padding: 4px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            border-bottom: 1px solid var(--border);
            font-size: 0.6rem;
        }
        .threats-display { display: flex; gap: 10px; }
        .threat-counter { display: flex; align-items: center; gap: 3px; }
        .threat-counter.shahed { color: var(--status-orange); }
        .threat-counter.rocket { color: var(--status-red); }
        .threat-counter.ballistic { color: var(--status-purple); }
        .kyiv-map { width: 100%; height: 100%; }
        .district-shape {
            fill: rgba(63,185,80,0.12);
            stroke: var(--status-green);
            stroke-width: 1.5;
            cursor: pointer;
            transition: all 0.2s;
        }
        .district-shape:hover { fill: rgba(63,185,80,0.25); stroke-width: 2; }
        .district-shape.warning { fill: rgba(210,153,34,0.15); stroke: var(--status-yellow); }
        .district-shape.danger { fill: rgba(248,81,73,0.2); stroke: var(--status-red); animation: pulse 1s infinite; }
        @keyframes pulse {
            0%,100% { fill: rgba(248,81,73,0.15); }
            50% { fill: rgba(248,81,73,0.3); }
        }
        .district-label { font-size: 7px; fill: var(--text-secondary); pointer-events: none; text-anchor: middle; }
        .district-power { font-size: 6px; fill: var(--accent-cyan); pointer-events: none; text-anchor: middle; }
        .attack-path { stroke-width: 2; stroke-dasharray: 5,3; fill: none; opacity: 0.7; }
        .attack-path.shahed { stroke: var(--status-orange); }
        .attack-path.rocket { stroke: var(--status-red); }
        .attack-path.ballistic { stroke: var(--status-purple); }

        /* TOOLTIP */
        .tooltip {
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            z-index: 100;
            pointer-events: none;
            display: none;
            max-width: 220px;
            font-size: 0.55rem;
        }
        .tooltip.active { display: block; }
        .tooltip-title { font-weight: 700; color: var(--accent-cyan); margin-bottom: 4px; font-size: 0.65rem; }
        .tooltip-subgroup { margin-top: 4px; padding-top: 4px; border-top: 1px solid var(--border); }
        .tooltip-subgroup-num { color: var(--status-green); font-weight: 600; }
        .tooltip-streets { color: var(--text-muted); font-size: 0.5rem; }

        /* CONTROLS SECTION */
        .controls-section {
            grid-column: 2;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .controls-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            padding: 6px;
            overflow-y: auto;
        }
        .district-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px;
        }
        .district-card.has-damage { border-color: var(--status-red); }
        .district-card.has-off { border-color: var(--status-yellow); }
        .district-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            padding-bottom: 3px;
            border-bottom: 1px solid var(--border);
        }
        .district-card-name { font-size: 0.55rem; font-weight: 600; }
        .district-card-power { font-size: 0.5rem; color: var(--accent-cyan); }
        .subgroups-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 2px; }
        .subgroup-btn {
            background: rgba(63,185,80,0.15);
            border: 1px solid var(--status-green);
            border-radius: 3px;
            padding: 3px 2px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.5rem;
            font-weight: 600;
            color: var(--status-green);
            transition: all 0.1s;
        }
        .subgroup-btn:hover:not(.damaged) { transform: scale(1.05); }
        .subgroup-btn.off { background: rgba(210,153,34,0.15); border-color: var(--status-yellow); color: var(--status-yellow); }
        .subgroup-btn.damaged { background: rgba(248,81,73,0.2); border-color: var(--status-red); color: var(--status-red); cursor: not-allowed; }
        .controls-actions {
            display: flex;
            gap: 4px;
            padding: 6px;
            border-top: 1px solid var(--border);
        }
        .action-btn {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.55rem;
        }
        .action-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
        .action-btn.success:hover { border-color: var(--status-green); color: var(--status-green); }
        .action-btn.danger:hover { border-color: var(--status-red); color: var(--status-red); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* RIGHT PANEL */
        .right-panel {
            grid-row: 1 / 3;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .threats-panel, .upgrades-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        .threats-panel { flex-shrink: 0; }
        .upgrades-panel { flex: 1; display: flex; flex-direction: column; }
        .wave-display { padding: 8px; text-align: center; border-bottom: 1px solid var(--border); }
        .wave-number { font-size: 1.3rem; font-weight: 700; color: var(--accent-cyan); }
        .wave-number.danger { color: var(--status-red); animation: pulse 0.5s infinite; }
        .wave-timer { font-size: 0.7rem; color: var(--text-secondary); }
        .wave-phase { font-size: 0.55rem; margin-top: 3px; padding: 2px 6px; border-radius: 8px; display: inline-block; }
        .wave-phase.prep { background: rgba(63,185,80,0.2); color: var(--status-green); }
        .wave-phase.attack { background: rgba(248,81,73,0.2); color: var(--status-red); }
        .threat-slots { padding: 6px; max-height: 120px; overflow-y: auto; }
        .threat-slot {
            background: var(--bg-card);
            border-radius: 3px;
            padding: 4px 6px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.5rem;
        }
        .threat-icon { font-size: 12px; }
        .threat-info { flex: 1; }
        .threat-name { color: var(--text-primary); font-weight: 600; }
        .threat-target { color: var(--text-muted); font-size: 0.45rem; }
        .upgrades-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .upgrade-tab {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.55rem;
            border-bottom: 2px solid transparent;
        }
        .upgrade-tab:hover { color: var(--text-secondary); }
        .upgrade-tab.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }
        .upgrades-list { flex: 1; overflow-y: auto; padding: 6px; }
        .upgrade-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px;
            margin-bottom: 3px;
            cursor: pointer;
        }
        .upgrade-item:hover:not(.bought):not(.locked) { border-color: var(--accent-cyan); }
        .upgrade-item.bought { border-color: var(--status-green); opacity: 0.7; }
        .upgrade-item.locked { opacity: 0.4; cursor: not-allowed; }
        .upgrade-header { display: flex; justify-content: space-between; }
        .upgrade-name { font-size: 0.55rem; font-weight: 600; }
        .upgrade-cost { font-size: 0.5rem; color: #ffd700; }
        .upgrade-desc { font-size: 0.45rem; color: var(--text-muted); margin-top: 2px; }

        /* OVERLAYS */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 200;
        }
        .overlay.active { display: flex; }
        .overlay-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 12px; }
        .overlay-title.defeat { color: var(--status-red); }
        .overlay-title.victory { color: var(--neon-green); }
        .overlay-stats { color: var(--text-secondary); text-align: center; margin-bottom: 20px; line-height: 1.6; font-size: 0.8rem; }
        .overlay-btn {
            background: var(--accent-cyan);
            border: none;
            color: var(--bg-primary);
            padding: 10px 28px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .overload-banner {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%,-50%);
            background: rgba(248,81,73,0.95);
            color: white;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            z-index: 150;
            display: none;
            text-align: center;
        }
        .overload-banner.active { display: block; animation: glow 0.5s infinite; }
        .explosion {
            position: absolute;
            width: 30px; height: 30px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,200,50,0.9), rgba(248,81,73,0.5) 50%, transparent 70%);
            animation: explode 0.4s forwards;
            pointer-events: none;
            z-index: 25;
        }
        @keyframes explode {
            0% { transform: translate(-50%,-50%) scale(0); opacity: 1; }
            100% { transform: translate(-50%,-50%) scale(2.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">–î–¢–ï–ö SIMULATOR</div>
        <div class="header-stats">
            <div class="stat-pill">
                <span class="stat-label">–î–ï–ù–¨</span>
                <span class="stat-value cyan" id="day-num">1</span>
            </div>
            <div class="stat-pill" id="load-pill">
                <span class="stat-label">–ú–ï–†–ï–ñ–ê</span>
                <span class="stat-value green" id="load-value">68%</span>
                <div class="mini-bar"><div class="mini-bar-fill green" id="load-bar" style="width:68%"></div></div>
            </div>
            <div class="stat-pill">
                <span class="stat-label">–ì–ï–ù–ï–†–ê–¶–Ü–Ø</span>
                <span class="stat-value cyan" id="gen-value">1200</span>
                <span class="stat-label">MW</span>
            </div>
            <div class="stat-pill">
                <span class="stat-label">‚Ç¥</span>
                <span class="stat-value gold" id="money-value">500</span>
            </div>
            <div class="stat-pill">
                <span class="stat-value gold" id="reputation">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span>
            </div>
            <button class="btn-sm" onclick="togglePause()" id="pause-btn">‚è∏ –ü–ê–£–ó–ê</button>
        </div>
    </header>

    <div class="main-layout">
        <div class="left-panel">
            <div class="panel-header">üë∑ –ü–ï–†–°–û–ù–ê–õ</div>
            <div class="units-section">
                <div class="unit-row">
                    <span class="unit-icon">üîß</span>
                    <div class="unit-info">
                        <div class="unit-name">–†–µ–º–æ–Ω—Ç–Ω–∏–∫–∏</div>
                        <div class="unit-level">Lv.<span id="repair-lvl">1</span> –ù–æ–≤–æ–±—Ä–∞–Ω—Ü—ñ</div>
                    </div>
                </div>
                <div class="unit-row">
                    <span class="unit-icon">üìû</span>
                    <div class="unit-info">
                        <div class="unit-name">–û–ø–µ—Ä–∞—Ç–æ—Ä–∏</div>
                        <div class="unit-level">Lv.<span id="operator-lvl">1</span> –°—Ç–∞–∂–µ—Ä–∏</div>
                    </div>
                </div>
            </div>
            <div class="panel-header">üìã –ü–û–î–Ü–á</div>
            <div class="events-section" id="events-list"></div>
        </div>

        <div class="map-section" id="map-section">
            <div class="map-header">
                <span>üó∫Ô∏è –ö–ò–á–í</span>
                <div class="threats-display">
                    <span class="threat-counter shahed">üõ©Ô∏è<span id="cnt-shahed">0</span></span>
                    <span class="threat-counter rocket">üöÄ<span id="cnt-rocket">0</span></span>
                    <span class="threat-counter ballistic">‚òÑÔ∏è<span id="cnt-ballistic">0</span></span>
                </div>
            </div>
            <svg class="kyiv-map" viewBox="0 0 550 260" id="kyiv-svg">
                <path d="M340,0 Q360,80 350,130 Q340,180 360,260" stroke="var(--accent-cyan)" stroke-width="10" fill="none" opacity="0.1"/>
                <g id="districts-layer"></g>
                <g id="attacks-layer"></g>
            </svg>
        </div>

        <div class="controls-section">
            <div class="panel-header" style="display:flex;justify-content:space-between">
                <span>‚ö° –ü–Ü–î–ì–†–£–ü–ò</span>
                <span id="total-power">0 MW</span>
            </div>
            <div class="controls-grid" id="controls-grid"></div>
            <div class="controls-actions">
                <button class="action-btn success" onclick="enableAll()">‚úì –í—Å–µ ON</button>
                <button class="action-btn" onclick="useReserve()" id="reserve-btn" disabled>üîã +300MW</button>
                <button class="action-btn danger" onclick="emergencyOff()">‚ö† -3 –≥—Ä—É–ø–∏</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="threats-panel">
                <div class="panel-header">üéØ –ó–ê–ì–†–û–ó–ò</div>
                <div class="wave-display">
                    <div class="wave-number" id="wave-num">1</div>
                    <div class="wave-timer" id="wave-timer">0:45</div>
                    <div class="wave-phase prep" id="wave-phase">–ü–Ü–î–ì–û–¢–û–í–ö–ê</div>
                </div>
                <div class="threat-slots" id="threat-slots"></div>
            </div>
            <div class="upgrades-panel">
                <div class="upgrades-tabs">
                    <button class="upgrade-tab active" data-tab="infra" onclick="showTab('infra')">üèóÔ∏è –Ü–Ω—Ñ—Ä–∞</button>
                    <button class="upgrade-tab" data-tab="defense" onclick="showTab('defense')">üõ°Ô∏è –ó–∞—Ö–∏—Å—Ç</button>
                    <button class="upgrade-tab" data-tab="units" onclick="showTab('units')">üë∑ –Æ–Ω—ñ—Ç–∏</button>
                </div>
                <div class="upgrades-list" id="upgrades-list"></div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>
    <div class="overlay" id="game-overlay">
        <div class="overlay-title" id="overlay-title">–ë–õ–ï–ö–ê–£–¢</div>
        <div class="overlay-stats" id="overlay-stats"></div>
        <button class="overlay-btn" onclick="location.reload()">üîÑ –ó–Ω–æ–≤—É</button>
    </div>
    <div class="overload-banner" id="overload-banner">‚ö†Ô∏è –ü–ï–†–ï–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø!</div>

<script>
// ========== DATA ==========
const THREATS = [
    { id:'shahed136', name:'–®–∞—Ö–µ–¥-136', icon:'üõ©Ô∏è', type:'shahed', speed:0.012, dmg:1, wave:1 },
    { id:'shahed131', name:'–®–∞—Ö–µ–¥-131', icon:'üõ©Ô∏è', type:'shahed', speed:0.015, dmg:1, wave:2 },
    { id:'geran2', name:'–ì–µ—Ä–∞–Ω-2', icon:'üõ©Ô∏è', type:'shahed', speed:0.018, dmg:1, wave:3 },
    { id:'decoy', name:'–î–µ–∫–æ–π', icon:'üéØ', type:'shahed', speed:0.025, dmg:0, wave:3 },
    { id:'swarm', name:'–†—ñ–π –¥—Ä–æ–Ω—ñ–≤', icon:'ü¶ü', type:'shahed', speed:0.01, dmg:2, wave:5 },
    { id:'kalibr', name:'–ö–∞–ª—ñ–±—Ä', icon:'üöÄ', type:'rocket', speed:0.04, dmg:2, wave:4 },
    { id:'x101', name:'–•-101', icon:'üöÄ', type:'rocket', speed:0.045, dmg:2, wave:5 },
    { id:'iskander', name:'–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú', icon:'‚òÑÔ∏è', type:'ballistic', speed:0.07, dmg:3, wave:7 },
    { id:'kn23', name:'–ö–ù-23', icon:'‚òÑÔ∏è', type:'ballistic', speed:0.08, dmg:3, wave:8 },
    { id:'kinzhal', name:'–ö–∏–Ω–¥–∂–∞–ª', icon:'‚ö°', type:'ballistic', speed:0.1, dmg:4, wave:9 },
    { id:'zircon', name:'–¶–∏—Ä–∫–æ–Ω', icon:'üí´', type:'ballistic', speed:0.12, dmg:4, wave:10 },
    { id:'oreshnik', name:'–û—Ä–µ—à–Ω—ñ–∫', icon:'üî•', type:'boss', speed:0.06, dmg:6, wave:12 }
];

const REPAIR_LEVELS = ['–ù–æ–≤–æ–±—Ä–∞–Ω—Ü—ñ','–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –±—Ä–∏–≥–∞–¥–∞','–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞','–ú–æ–±—ñ–ª—å–Ω–∞ –≥—Ä—É–ø–∞','–ï–ª—ñ—Ç–Ω—ñ —ñ–Ω–∂–µ–Ω–µ—Ä–∏','–ù—ñ—á–Ω–∞ –±—Ä–∏–≥–∞–¥–∞','–î—Ä–æ–Ω-–∞—Å–∏—Å—Ç–æ–≤–∞–Ω–∞','–ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä–Ω–∞'];
const OPERATOR_LEVELS = ['–°—Ç–∞–∂–µ—Ä–∏','–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ','–î–æ—Å–≤—ñ–¥—á–µ–Ω—ñ','–ú–æ–≤–Ω—ñ —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç–∏','–°—Ç—Ä–µ—Å–æ—Å—Ç—ñ–π–∫—ñ','AI-–ø—ñ–¥—Ç—Ä–∏–º–∞–Ω—ñ','–ö—Ä–∏–∑–æ–≤—ñ –º–µ–Ω–µ–¥–∂–µ—Ä–∏'];

const UPGRADES = {
    infra: [
        { id:'gen1', name:'‚ö° –ú—ñ–Ω—ñ–º–æ–¥–µ—Ä–Ω—ñ–∑–∞—Ü—ñ—è –¢–ï–¶', desc:'+50 MW', cost:80, effect:()=>G.generation+=50 },
        { id:'gen2', name:'üîã –†–µ–∑–µ—Ä–≤–Ω—ñ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∏', desc:'–†–æ–∑–±–ª–æ–∫—É—î –†–µ–∑–µ—Ä–≤', cost:120, effect:()=>G.hasReserve=true },
        { id:'gen3', name:'üöõ –ú–æ–±—ñ–ª—å–Ω—ñ –¥–∏–∑–µ–ª—ñ', desc:'+80 MW', cost:180, effect:()=>G.generation+=80 },
        { id:'gen4', name:'‚òÄÔ∏è –°–æ–Ω—è—á–Ω—ñ –ø–∞–Ω–µ–ª—ñ', desc:'+40 MW', cost:220, effect:()=>G.generation+=40 },
        { id:'gen5', name:'üè≠ –¢–ï–¶-5 –∞–ø–≥—Ä–µ–π–¥', desc:'+150 MW', cost:400, effect:()=>G.generation+=150 },
        { id:'auto', name:'üîÑ –ê–≤—Ç–æ-–≤–∏–º–∏–∫–∞—á—ñ', desc:'–ê–≤—Ç–æ –ø—Ä–∏ 92%', cost:300, effect:()=>G.hasAuto=true },
        { id:'smart', name:'üí° Smart Grid', desc:'+5% –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ', cost:500, effect:()=>G.efficiency+=0.05 },
        { id:'super', name:'‚ö° –°—É–ø–µ—Ä-–¢–ï–¶', desc:'+250 MW', cost:800, effect:()=>G.generation+=250 }
    ],
    defense: [
        { id:'reb', name:'üì° –†–ï–ë-—Å—Ç–∞–Ω—Ü—ñ—ó', desc:'-15% —à–∞—Ö–µ–¥—ñ–≤', cost:150, effect:()=>G.shahedDef+=0.15 },
        { id:'trans', name:'üîã –†–µ–∑–µ—Ä–≤–Ω—ñ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä–∏', desc:'-20% —Ä–µ–º–æ–Ω—Ç—É', cost:200, effect:()=>G.repairBonus+=0.2 },
        { id:'ppo', name:'üöÄ –ú–æ–±—ñ–ª—å–Ω—ñ –ü–ü–û', desc:'-20% —Ä–∞–∫–µ—Ç', cost:350, effect:()=>G.rocketDef+=0.2 },
        { id:'cable', name:'üîå –ü—ñ–¥–∑–µ–º–Ω—ñ –∫–∞–±–µ–ª—ñ', desc:'-25% –ø–æ—à–∫–æ–¥–∂–µ–Ω—å', cost:400, effect:()=>G.dmgReduction+=0.25 },
        { id:'air', name:'‚úàÔ∏è –ü–æ–≤—ñ—Ç—Ä—è–Ω–∏–π —â–∏—Ç', desc:'-20% –≤—Å—ñ—Ö', cost:600, effect:()=>G.globalDef+=0.2 },
        { id:'mega', name:'üè∞ –ú–µ–≥–∞—Ä—Ö–∞–±', desc:'–ü–µ—á–µ—Ä—Å—å–∫ –∑–∞—Ö–∏—â–µ–Ω–æ', cost:900, effect:()=>G.shielded='pechersk' }
    ],
    units: [
        { id:'rep2', name:'üîß –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –±—Ä–∏–≥–∞–¥–∞', desc:'–†–µ–º–æ–Ω—Ç 35—Å', cost:100, effect:()=>{G.repairLvl=2;G.repairTime=35} },
        { id:'rep3', name:'üîß –°–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞', desc:'–†–µ–º–æ–Ω—Ç 28—Å', cost:200, effect:()=>{G.repairLvl=3;G.repairTime=28} },
        { id:'rep4', name:'üîß –ú–æ–±—ñ–ª—å–Ω–∞ –≥—Ä—É–ø–∞', desc:'–†–µ–º–æ–Ω—Ç 22—Å', cost:350, effect:()=>{G.repairLvl=4;G.repairTime=22} },
        { id:'rep5', name:'üîß –ï–ª—ñ—Ç–Ω—ñ —ñ–Ω–∂–µ–Ω–µ—Ä–∏', desc:'–†–µ–º–æ–Ω—Ç 16—Å', cost:500, effect:()=>{G.repairLvl=5;G.repairTime=16} },
        { id:'op2', name:'üìû –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∏', desc:'–°–∫–∞—Ä–≥–∏ x2', cost:80, effect:()=>{G.opLvl=2;G.opCapacity=20} },
        { id:'op3', name:'üìû –î–æ—Å–≤—ñ–¥—á–µ–Ω—ñ', desc:'–°–∫–∞—Ä–≥–∏ x3', cost:160, effect:()=>{G.opLvl=3;G.opCapacity=35} }
    ]
};

const DISTRICTS = [
    { id:'obolon', name:'–û–±–æ–ª–æ–Ω—å', power:140, x:150, y:45, subgroups:[
        {streets:'–ø—Ä–æ—Å–ø. –û–±–æ–ª–æ–Ω—Å—å–∫–∏–π, –¢–∏–º–æ—à–µ–Ω–∫–∞'},
        {streets:'–ü–µ—Ç—Ä–∞ –ü–∞–Ω—á–∞, –ó–æ—ó –ì–∞–π–¥–∞–π'},
        {streets:'–ë–µ—Ä–µ–∂–∞–Ω—Å—å–∫–∞, –ü—Ä–∏—Ä—ñ–Ω–∞'},
        {streets:'–õ–∞–π–æ—à–∞ –ì–∞–≤—Ä–æ, –ë–æ–≥–∞—Ç–∏—Ä—Å—å–∫–∞'}
    ]},
    { id:'podil', name:'–ü–æ–¥—ñ–ª', power:100, x:230, y:60, subgroups:[
        {streets:'–ø—Ä–æ—Å–ø. –ë–∞–Ω–¥–µ—Ä–∏, –¢—É–ª—å—á–∏–Ω—Å—å–∫–∞'},
        {streets:'–•–≤–æ–π–∫–∏, –°–ø–∞—Å—å–∫–∞'},
        {streets:'–•–æ—Ä–∏–≤–∞, –ü–æ—á–∞–π–Ω–∏–Ω—Å—å–∫–∞'}
    ]},
    { id:'shevchenko', name:'–®–µ–≤—á–µ–Ω–∫–æ', power:130, x:140, y:115, subgroups:[
        {streets:'–í–æ–ª–æ–¥–∏–º–∏—Ä—Å—å–∫–∞, –°–∞–∫—Å–∞–≥–∞–Ω—Å—å–∫–æ–≥–æ'},
        {streets:'–±—É–ª. –®–µ–≤—á–µ–Ω–∫–∞, –ü—É—à–∫—ñ–Ω—Å—å–∫–∞'},
        {streets:'–ñ–∏–ª—è–Ω—Å—å–∫–∞, –¢–∞—Ä–∞—Å—ñ–≤—Å—å–∫–∞'},
        {streets:'–ì–æ–Ω—á–∞—Ä–∞, –†–µ–π—Ç–∞—Ä—Å—å–∫–∞'}
    ]},
    { id:'pechersk', name:'–ü–µ—á–µ—Ä—Å—å–∫', power:150, x:270, y:125, subgroups:[
        {streets:'–±—É–ª. –õ–µ—Å—ñ –£–∫—Ä–∞—ó–Ω–∫–∏, –ß–∏–≥–æ—Ä—ñ–Ω–∞'},
        {streets:'–°—Ç–∞—Ä–æ–Ω–∞–≤–æ–¥–Ω–∏—Ü—å–∫–∞, –ú–∞–∫–∫–µ–π–Ω–∞'},
        {streets:'–ö–ª–æ–≤—Å—å–∫–∏–π —É–∑–≤—ñ–∑, –®–æ–≤–∫–æ–≤–∏—á–Ω–∞'},
        {streets:'–ú–∞–∑–µ–ø–∏, –ì—Ä—É—à–µ–≤—Å—å–∫–æ–≥–æ'}
    ]},
    { id:'sviatoshyn', name:'–°–≤—è—Ç–æ—à–∏–Ω', power:110, x:50, y:105, subgroups:[
        {streets:'–±—É–ª. –í–µ—Ä–Ω–∞–¥—Å—å–∫–æ–≥–æ, –ü–æ–ø–æ–≤–∏—á–∞'},
        {streets:'–¢–∞—Ä–∞—â–∞–Ω—Å—å–∫–∞, –ì–µ—Ä–æ—ó–≤ –ö–æ—Å–º–æ—Å—É'},
        {streets:'–ö–æ—Ç–µ–ª—å–Ω–∏–∫–æ–≤–∞, –ó–æ–¥—á–∏—Ö'}
    ]},
    { id:'solomianka', name:"–°–æ–ª–æ–º'—è–Ω–∫–∞", power:95, x:100, y:175, subgroups:[
        {streets:'–í.–ì–µ—Ç—å–º–∞–Ω–∞, –°–º—ñ–ª—è–Ω—Å—å–∫–∞'},
        {streets:'–í–æ–ª–∏–Ω—Å—å–∫–∞, –ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∞'},
        {streets:"–°–æ–ª–æ–º'—è–Ω—Å—å–∫–∞, –ê–Ω—Ç–æ–Ω–æ–≤–∞"}
    ]},
    { id:'holosiiv', name:'–ì–æ–ª–æ—Å—ñ—ó–≤', power:105, x:200, y:195, subgroups:[
        {streets:'–ì–ª—É—à–∫–æ–≤–∞, –í–∞—Å–∏–ª—å–∫—ñ–≤—Å—å–∫–∞'},
        {streets:'–ê–Ω—Ç–æ–Ω–æ–≤–∏—á–∞, –ó–∞–±–æ–ª–æ—Ç–Ω–æ–≥–æ'},
        {streets:'–õ–æ–º–æ–Ω–æ—Å–æ–≤–∞, –¢–µ—Ä–µ–º–∫—ñ–≤—Å—å–∫–∞'}
    ]},
    { id:'desnianskyi', name:'–î–µ—Å–Ω—è–Ω—Å—å–∫–∏–π', power:135, x:420, y:50, subgroups:[
        {streets:'–ß–µ—Ä–≤–æ–Ω–æ—ó –ö–∞–ª–∏–Ω–∏, –õ–∏—Ñ–∞—Ä—è'},
        {streets:'–ë–∞–ª—å–∑–∞–∫–∞, –ú–∞—è–∫–æ–≤—Å—å–∫–æ–≥–æ'},
        {streets:'–ó–∞–∫—Ä–µ–≤—Å—å–∫–æ–≥–æ, –î—Ä–∞–π–∑–µ—Ä–∞'},
        {streets:'–ú–∏–ª–æ—Å–ª–∞–≤—Å—å–∫–∞, –ì—Ä–∞–¥–∏–Ω—Å—å–∫–∞'}
    ]},
    { id:'dnipro', name:'–î–Ω—ñ–ø—Ä–æ–≤—Å—å–∫–∏–π', power:115, x:450, y:130, subgroups:[
        {streets:'–±—É–ª. –ü—Ä–∞—Ü—ñ, –•–∞—Ä–∫—ñ–≤—Å—å–∫–µ —à–æ—Å–µ'},
        {streets:'–†—É—Å–∞–Ω—ñ–≤—Å—å–∫–∞ –Ω–∞–±.'},
        {streets:'–í–æ—Å–∫—Ä–µ—Å–µ–Ω—Å—å–∫–∞'}
    ]},
    { id:'darnytsia', name:'–î–∞—Ä–Ω–∏—Ü—è', power:125, x:500, y:190, subgroups:[
        {streets:'–ø—Ä–æ—Å–ø. –ì—Ä–∏–≥–æ—Ä–µ–Ω–∫–∞, –ë–∞–∂–∞–Ω–∞'},
        {streets:'–ê—Ö–º–∞—Ç–æ–≤–æ—ó, –í–µ—Ä–±–∏—Ü—å–∫–æ–≥–æ'},
        {streets:'–î—Ä–∞–≥–æ–º–∞–Ω–æ–≤–∞'},
        {streets:'—Å. –ë–æ—Ä—Ç–Ω–∏—á—ñ'}
    ]}
];

// ========== STATE ==========
const G = {
    paused: false,
    gameOver: false,
    day: 1,
    generation: 1200,
    consumption: 800,
    load: 67,
    maxLoad: 67,
    money: 500,
    reputation: 3,
    
    repairLvl: 1,
    repairTime: 45,
    repairBonus: 0,
    opLvl: 1,
    opCapacity: 10,
    
    hasReserve: false,
    hasAuto: false,
    efficiency: 1,
    shahedDef: 0,
    rocketDef: 0,
    globalDef: 0,
    dmgReduction: 0,
    shielded: null,
    
    wave: { num:1, phase:'prep', time:45, threats:[] },
    districts: {},
    boughtUpgrades: new Set(),
    currentTab: 'infra'
};

// Init districts
DISTRICTS.forEach(d => {
    const subs = [];
    for(let i=0; i<d.subgroups.length; i++){
        subs.push({ num:i+1, status:'on', power:Math.round(d.power/d.subgroups.length), streets:d.subgroups[i].streets });
    }
    G.districts[d.id] = { ...d, subs };
});

// ========== RENDER ==========
function renderMap(){
    const layer = document.getElementById('districts-layer');
    layer.innerHTML = '';
    
    DISTRICTS.forEach(d => {
        const dist = G.districts[d.id];
        const hasDmg = dist.subs.some(s=>s.status==='damaged');
        const hasOff = dist.subs.some(s=>s.status==='off');
        const curPower = dist.subs.filter(s=>s.status==='on').reduce((a,s)=>a+s.power,0);
        
        let cls = 'district-shape';
        if(hasDmg) cls += ' danger';
        else if(hasOff) cls += ' warning';
        
        const size = 35 + d.power/10;
        const path = `M${d.x},${d.y-size/2} L${d.x+size/2},${d.y} L${d.x},${d.y+size/2} L${d.x-size/2},${d.y} Z`;
        
        const shape = document.createElementNS('http://www.w3.org/2000/svg','path');
        shape.setAttribute('d', path);
        shape.setAttribute('class', cls);
        shape.setAttribute('id', 'map-'+d.id);
        shape.onmouseenter = (e) => showTooltip(e, d.id);
        shape.onmouseleave = hideTooltip;
        layer.appendChild(shape);
        
        const label = document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('x', d.x);
        label.setAttribute('y', d.y-3);
        label.setAttribute('class', 'district-label');
        label.textContent = d.name;
        layer.appendChild(label);
        
        const power = document.createElementNS('http://www.w3.org/2000/svg','text');
        power.setAttribute('x', d.x);
        power.setAttribute('y', d.y+8);
        power.setAttribute('class', 'district-power');
        power.textContent = curPower+'MW';
        power.id = 'power-'+d.id;
        layer.appendChild(power);
    });
}

function renderControls(){
    const grid = document.getElementById('controls-grid');
    let total = 0;
    
    grid.innerHTML = Object.entries(G.districts).map(([id, d]) => {
        const hasDmg = d.subs.some(s=>s.status==='damaged');
        const hasOff = d.subs.some(s=>s.status==='off');
        const curPower = d.subs.filter(s=>s.status==='on').reduce((a,s)=>a+s.power,0);
        total += curPower;
        
        let cls = 'district-card';
        if(hasDmg) cls += ' has-damage';
        else if(hasOff) cls += ' has-off';
        
        return `<div class="${cls}">
            <div class="district-card-header">
                <span class="district-card-name">${d.name}</span>
                <span class="district-card-power">${curPower}MW</span>
            </div>
            <div class="subgroups-grid">
                ${d.subs.map(s => `
                    <button class="subgroup-btn ${s.status}" onclick="toggleSub('${id}',${s.num})" ${s.status==='damaged'?'disabled':''}>
                        ${s.num}<br><span style="font-size:0.4rem">${s.power}</span>
                    </button>
                `).join('')}
            </div>
        </div>`;
    }).join('');
    
    document.getElementById('total-power').textContent = total + ' MW';
}

function renderThreats(){
    const slots = document.getElementById('threat-slots');
    if(G.wave.threats.length === 0){
        slots.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:10px;font-size:0.5rem">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≥—Ä–æ–∑</div>';
        return;
    }
    slots.innerHTML = G.wave.threats.map(t => `
        <div class="threat-slot">
            <span class="threat-icon">${t.icon}</span>
            <div class="threat-info">
                <div class="threat-name">${t.name}</div>
                <div class="threat-target">‚Üí ${G.districts[t.targetId]?.name || '?'}</div>
            </div>
        </div>
    `).join('');
}

function renderUpgrades(){
    const list = document.getElementById('upgrades-list');
    const ups = UPGRADES[G.currentTab] || [];
    
    list.innerHTML = ups.map(u => {
        const bought = G.boughtUpgrades.has(u.id);
        const canBuy = G.money >= u.cost && !bought;
        let cls = 'upgrade-item';
        if(bought) cls += ' bought';
        else if(!canBuy) cls += ' locked';
        
        return `<div class="${cls}" onclick="buyUpgrade('${u.id}')">
            <div class="upgrade-header">
                <span class="upgrade-name">${u.name}</span>
                <span class="upgrade-cost">${bought ? '‚úì' : u.cost+'‚Ç¥'}</span>
            </div>
            <div class="upgrade-desc">${u.desc}</div>
        </div>`;
    }).join('');
}

function showTab(tab){
    G.currentTab = tab;
    document.querySelectorAll('.upgrade-tab').forEach(t => t.classList.toggle('active', t.dataset.tab===tab));
    renderUpgrades();
}

function showTooltip(e, id){
    const d = G.districts[id];
    const tip = document.getElementById('tooltip');
    tip.innerHTML = `
        <div class="tooltip-title">${d.name}</div>
        ${d.subs.map(s => `
            <div class="tooltip-subgroup">
                <span class="tooltip-subgroup-num">–ì—Ä—É–ø–∞ ${s.num}</span> (${s.power}MW) - ${s.status==='on'?'üü¢':'üî¥'}<br>
                <span class="tooltip-streets">${s.streets}</span>
            </div>
        `).join('')}
    `;
    tip.style.left = (e.clientX + 15) + 'px';
    tip.style.top = (e.clientY + 10) + 'px';
    tip.classList.add('active');
}

function hideTooltip(){
    document.getElementById('tooltip').classList.remove('active');
}

function updateUI(){
    G.load = Math.round((G.consumption / G.generation) * 100 / G.efficiency);
    G.maxLoad = Math.max(G.maxLoad, G.load);
    
    const loadEl = document.getElementById('load-value');
    const loadBar = document.getElementById('load-bar');
    const loadPill = document.getElementById('load-pill');
    
    loadEl.textContent = G.load + '%';
    loadBar.style.width = Math.min(100, G.load) + '%';
    
    const cls = G.load >= 88 ? 'red' : G.load >= 70 ? 'yellow' : 'green';
    loadEl.className = 'stat-value ' + cls;
    loadBar.className = 'mini-bar-fill ' + cls;
    loadPill.classList.toggle('danger', G.load >= 88);
    
    document.getElementById('gen-value').textContent = G.generation;
    document.getElementById('money-value').textContent = G.money;
    document.getElementById('day-num').textContent = G.day;
    
    const stars = '‚òÖ'.repeat(G.reputation) + '‚òÜ'.repeat(5-G.reputation);
    document.getElementById('reputation').textContent = stars;
    
    document.getElementById('repair-lvl').textContent = G.repairLvl;
    document.getElementById('operator-lvl').textContent = G.opLvl;
    
    const w = G.wave;
    document.getElementById('wave-num').textContent = w.num;
    document.getElementById('wave-num').classList.toggle('danger', w.phase==='attack');
    
    const m = Math.floor(w.time/60), s = w.time%60;
    document.getElementById('wave-timer').textContent = `${m}:${String(s).padStart(2,'0')}`;
    
    const phase = document.getElementById('wave-phase');
    phase.textContent = w.phase==='prep' ? '–ü–Ü–î–ì–û–¢–û–í–ö–ê' : '–ê–¢–ê–ö–ê!';
    phase.className = 'wave-phase ' + w.phase;
    
    // Threat counters
    const shaheds = w.threats.filter(t=>t.type==='shahed').length;
    const rockets = w.threats.filter(t=>t.type==='rocket').length;
    const ballistic = w.threats.filter(t=>t.type==='ballistic'||t.type==='boss').length;
    document.getElementById('cnt-shahed').textContent = shaheds;
    document.getElementById('cnt-rocket').textContent = rockets;
    document.getElementById('cnt-ballistic').textContent = ballistic;
    
    document.getElementById('reserve-btn').disabled = !G.hasReserve;
    document.getElementById('overload-banner').classList.toggle('active', G.load >= 90);
    
    // Update map powers
    Object.entries(G.districts).forEach(([id, d]) => {
        const el = document.getElementById('power-'+id);
        if(el) el.textContent = d.subs.filter(s=>s.status==='on').reduce((a,s)=>a+s.power,0) + 'MW';
        
        const shape = document.getElementById('map-'+id);
        if(shape){
            const hasDmg = d.subs.some(s=>s.status==='damaged');
            const hasOff = d.subs.some(s=>s.status==='off');
            shape.classList.toggle('danger', hasDmg);
            shape.classList.toggle('warning', !hasDmg && hasOff);
        }
    });
}

function addEvent(type, text){
    const list = document.getElementById('events-list');
    const t = new Date().toLocaleTimeString('uk-UA',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    list.insertAdjacentHTML('afterbegin', `<div class="event-item ${type}"><div class="event-time">${t}</div><div class="event-text">${text}</div></div>`);
    while(list.children.length > 20) list.removeChild(list.lastChild);
}

// ========== GAME LOGIC ==========
function gameTick(){
    if(G.paused || G.gameOver) return;
    
    G.wave.time--;
    
    if(G.wave.phase === 'prep'){
        if(G.wave.time <= 0) startAttack();
        else if(G.wave.time === 10) addEvent('warning', '‚ö†Ô∏è –ê—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥!');
    } else {
        if(G.wave.time > 3 && Math.random() < 0.35) spawnThreat();
        G.consumption += 8 + G.wave.num * 2;
        if(G.wave.time <= 0 || (G.wave.threats.length === 0 && G.wave.time < 10)) endWave();
    }
    
    updateThreats();
    
    G.consumption += Math.floor(Math.random() * 12) - 5;
    G.consumption = Math.max(500, G.consumption);
    
    if(G.hasAuto && G.load >= 92) autoBalance();
    
    if(G.load >= 100) gameOver();
    
    updateUI();
    renderThreats();
}

function startAttack(){
    G.wave.phase = 'attack';
    G.wave.time = 12 + G.wave.num * 2;
    addEvent('alert', `üî• –•–í–ò–õ–Ø ${G.wave.num} –ü–û–ß–ê–õ–ê–°–¨!`);
}

function spawnThreat(){
    const available = THREATS.filter(t => t.wave <= G.wave.num);
    const template = available[Math.floor(Math.random() * available.length)];
    
    // Defense chances
    let blocked = false;
    if(template.type === 'shahed' && Math.random() < G.shahedDef + G.globalDef) blocked = true;
    if(template.type === 'rocket' && Math.random() < G.rocketDef + G.globalDef) blocked = true;
    if(template.type === 'ballistic' && Math.random() < G.globalDef) blocked = true;
    
    if(blocked){
        addEvent('success', `üõ°Ô∏è ${template.name} –∑–±–∏—Ç–æ –ü–ü–û!`);
        return;
    }
    
    const distIds = Object.keys(G.districts).filter(id => id !== G.shielded);
    const targetId = distIds[Math.floor(Math.random() * distIds.length)];
    const target = DISTRICTS.find(d => d.id === targetId);
    
    const edges = [{x:-20,y:Math.random()*260},{x:570,y:Math.random()*260},{x:Math.random()*550,y:-20}];
    const start = edges[Math.floor(Math.random()*edges.length)];
    
    G.wave.threats.push({
        id: Date.now() + Math.random(),
        ...template,
        targetId,
        x: start.x, y: start.y,
        tx: target.x, ty: target.y,
        progress: 0
    });
}

function updateThreats(){
    const layer = document.getElementById('attacks-layer');
    layer.innerHTML = '';
    
    const toRemove = [];
    
    G.wave.threats.forEach(t => {
        t.progress += t.speed;
        
        if(t.progress >= 1){
            toRemove.push(t.id);
            if(t.dmg > 0) hitDistrict(t);
            showExplosion(t.tx, t.ty);
        } else {
            const cx = t.x + (t.tx - t.x) * t.progress;
            const cy = t.y + (t.ty - t.y) * t.progress;
            
            const path = document.createElementNS('http://www.w3.org/2000/svg','line');
            path.setAttribute('x1', cx);
            path.setAttribute('y1', cy);
            path.setAttribute('x2', t.tx);
            path.setAttribute('y2', t.ty);
            path.setAttribute('class', 'attack-path ' + t.type);
            layer.appendChild(path);
            
            const icon = document.createElementNS('http://www.w3.org/2000/svg','text');
            icon.setAttribute('x', cx);
            icon.setAttribute('y', cy);
            icon.setAttribute('font-size', '14');
            icon.setAttribute('text-anchor', 'middle');
            icon.textContent = t.icon;
            layer.appendChild(icon);
        }
    });
    
    G.wave.threats = G.wave.threats.filter(t => !toRemove.includes(t.id));
}

function hitDistrict(threat){
    const dist = G.districts[threat.targetId];
    if(!dist) return;
    
    let dmg = threat.dmg;
    dmg = Math.round(dmg * (1 - G.dmgReduction));
    if(dmg < 1) dmg = 1;
    
    const working = dist.subs.filter(s => s.status !== 'damaged');
    const toHit = working.slice(0, Math.min(dmg, working.length));
    
    toHit.forEach(s => {
        if(s.status === 'on') G.consumption -= s.power;
        s.status = 'damaged';
        
        const repairTime = Math.round(G.repairTime * 1000 * (1 - G.repairBonus));
        setTimeout(() => repairSub(threat.targetId, s.num), repairTime);
    });
    
    if(toHit.length > 0){
        addEvent('alert', `üí• ${threat.name} ‚Üí ${dist.name}! ${toHit.length} –≥—Ä—É–ø –ø–æ—à–∫–æ–¥–∂–µ–Ω–æ`);
        renderControls();
        G.reputation = Math.max(1, G.reputation - (toHit.length > 1 ? 1 : 0));
    }
}

function repairSub(distId, num){
    const dist = G.districts[distId];
    const sub = dist?.subs.find(s => s.num === num);
    if(sub && sub.status === 'damaged'){
        sub.status = 'on';
        G.consumption += sub.power;
        addEvent('success', `‚úì ${dist.name} –≥—Ä—É–ø–∞ ${num} –≤—ñ–¥—Ä–µ–º–æ–Ω—Ç–æ–≤–∞–Ω–∞`);
        renderControls();
    }
}

function showExplosion(x, y){
    const section = document.getElementById('map-section');
    const svg = document.getElementById('kyiv-svg');
    const rect = svg.getBoundingClientRect();
    const scaleX = rect.width / 550;
    const scaleY = rect.height / 260;
    
    const exp = document.createElement('div');
    exp.className = 'explosion';
    exp.style.left = (x * scaleX) + 'px';
    exp.style.top = (y * scaleY + 28) + 'px';
    section.appendChild(exp);
    setTimeout(() => exp.remove(), 400);
}

function endWave(){
    G.wave.threats = [];
    document.getElementById('attacks-layer').innerHTML = '';
    
    const reward = 50 + G.wave.num * 25;
    G.money += reward;
    
    addEvent('success', `‚úì –•–≤–∏–ª—è ${G.wave.num} –≤—ñ–¥–±–∏—Ç–∞! +${reward}‚Ç¥`);
    
    G.consumption = Math.max(550, G.consumption - 100);
    
    G.wave.num++;
    G.wave.phase = 'prep';
    G.wave.time = Math.max(25, 45 - G.wave.num * 2);
    
    if(G.wave.num % 3 === 0){
        G.day++;
        G.reputation = Math.min(5, G.reputation + 1);
    }
    
    renderUpgrades();
    
    if(G.wave.num > 15) victory();
}

function autoBalance(){
    for(const d of Object.values(G.districts)){
        const on = d.subs.find(s => s.status === 'on');
        if(on){
            on.status = 'off';
            G.consumption -= on.power;
            addEvent('info', `‚öñÔ∏è –ê–≤—Ç–æ: ${d.name} –≥—Ä.${on.num} –≤–∏–º–∫`);
            renderControls();
            break;
        }
    }
}

// ========== ACTIONS ==========
function toggleSub(distId, num){
    const sub = G.districts[distId].subs.find(s => s.num === num);
    if(sub.status === 'damaged') return;
    
    if(sub.status === 'on'){
        sub.status = 'off';
        G.consumption -= sub.power;
    } else {
        sub.status = 'on';
        G.consumption += sub.power;
    }
    renderControls();
}

function enableAll(){
    let cnt = 0;
    Object.values(G.districts).forEach(d => {
        d.subs.forEach(s => {
            if(s.status === 'off'){
                s.status = 'on';
                G.consumption += s.power;
                cnt++;
            }
        });
    });
    if(cnt) addEvent('info', `‚úì –£–≤—ñ–º–∫–Ω–µ–Ω–æ ${cnt} –≥—Ä—É–ø`);
    renderControls();
}

function emergencyOff(){
    let cnt = 0;
    for(const d of Object.values(G.districts)){
        for(const s of d.subs){
            if(s.status === 'on' && cnt < 3){
                s.status = 'off';
                G.consumption -= s.power;
                cnt++;
            }
        }
        if(cnt >= 3) break;
    }
    if(cnt) addEvent('warning', `‚ö†Ô∏è –ê–≤–∞—Ä—ñ–π–Ω–æ –≤–∏–º–∫–Ω–µ–Ω–æ ${cnt} –≥—Ä—É–ø`);
    renderControls();
}

function useReserve(){
    if(!G.hasReserve) return;
    const btn = document.getElementById('reserve-btn');
    if(btn.disabled) return;
    
    btn.disabled = true;
    G.generation += 300;
    addEvent('success', 'üîã –†–µ–∑–µ—Ä–≤ +300MW –Ω–∞ 15 —Å–µ–∫!');
    
    setTimeout(() => {
        G.generation -= 300;
        btn.disabled = false;
        addEvent('info', 'üîã –†–µ–∑–µ—Ä–≤ –≤–∏—á–µ—Ä–ø–∞–Ω–æ');
    }, 15000);
}

function buyUpgrade(id){
    const ups = [...UPGRADES.infra, ...UPGRADES.defense, ...UPGRADES.units];
    const u = ups.find(x => x.id === id);
    if(!u || G.boughtUpgrades.has(id) || G.money < u.cost) return;
    
    G.money -= u.cost;
    G.boughtUpgrades.add(id);
    u.effect();
    addEvent('success', `üîß –ö—É–ø–ª–µ–Ω–æ: ${u.name}`);
    renderUpgrades();
    updateUI();
}

function togglePause(){
    G.paused = !G.paused;
    document.getElementById('pause-btn').textContent = G.paused ? '‚ñ∂ –°–¢–ê–†–¢' : '‚è∏ –ü–ê–£–ó–ê';
}

function gameOver(){
    G.gameOver = true;
    document.getElementById('overlay-title').textContent = '‚ö´ –ë–õ–ï–ö–ê–£–¢';
    document.getElementById('overlay-title').className = 'overlay-title defeat';
    document.getElementById('overlay-stats').innerHTML = `–ü–µ—Ä–µ–∂–∏—Ç–æ —Ö–≤–∏–ª—å: ${G.wave.num-1}<br>–ú–∞–∫—Å. –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${G.maxLoad}%<br>–ó–∞—Ä–æ–±–ª–µ–Ω–æ: ${G.money}‚Ç¥`;
    document.getElementById('game-overlay').classList.add('active');
    document.getElementById('overload-banner').classList.remove('active');
}

function victory(){
    G.gameOver = true;
    document.getElementById('overlay-title').textContent = 'üèÜ –ü–ï–†–ï–ú–û–ì–ê!';
    document.getElementById('overlay-title').className = 'overlay-title victory';
    document.getElementById('overlay-stats').innerHTML = `–í—Å—ñ 15 —Ö–≤–∏–ª—å –≤—ñ–¥–±–∏—Ç–æ!<br>–î–µ–Ω—å: ${G.day}<br>–ú–∞–∫—Å. –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${G.maxLoad}%<br>–†–µ–ø—É—Ç–∞—Ü—ñ—è: ${'‚òÖ'.repeat(G.reputation)}`;
    document.getElementById('game-overlay').classList.add('active');
}

// ========== INIT ==========
renderMap();
renderControls();
renderUpgrades();
updateUI();
addEvent('info', 'üü¢ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –•–≤–∏–ª—è 1 —á–µ—Ä–µ–∑ 45 —Å–µ–∫—É–Ω–¥!');
setInterval(gameTick, 1000);
</script>
</body>
</html>
