<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–¢–ï–ö Simulator v7</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #0f1318;
            --bg-panel: #161b22;
            --bg-card: #1c2128;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-cyan: #39c5cf;
            --neon-green: #00ff88;
            --status-green: #3fb950;
            --status-yellow: #d29922;
            --status-orange: #db6d28;
            --status-red: #f85149;
            --status-purple: #a371f7;
            --ui-scale: 1;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            font-size: calc(12px * var(--ui-scale));
        }

        /* HEADER */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 4px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .logo {
            font-weight: 700;
            font-size: 0.9rem;
            background: linear-gradient(90deg, var(--accent-cyan), var(--neon-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-stats { display: flex; gap: 8px; align-items: center; }
        .stat-pill {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 3px 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.65rem;
        }
        .stat-pill.danger { border-color: var(--status-red); animation: glow 1s infinite; }
        @keyframes glow {
            0%,100% { box-shadow: 0 0 5px rgba(248,81,73,0.3); }
            50% { box-shadow: 0 0 12px rgba(248,81,73,0.5); }
        }
        .stat-label { color: var(--text-muted); font-size: 0.55rem; }
        .stat-value { font-weight: 700; }
        .green { color: var(--status-green); }
        .yellow { color: var(--status-yellow); }
        .red { color: var(--status-red); }
        .cyan { color: var(--accent-cyan); }
        .gold { color: #ffd700; }
        .mini-bar { width: 50px; height: 4px; background: var(--bg-primary); border-radius: 2px; overflow: hidden; }
        .mini-bar-fill { height: 100%; transition: all 0.3s; }
        .btn-sm {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 3px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.6rem;
        }
        .btn-sm:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
        .header-buttons { display: flex; gap: 4px; }

        /* MAIN LAYOUT */
        .main-layout {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 6px;
            overflow: hidden;
        }
        .top-section {
            display: flex;
            gap: 6px;
            height: 38%;
            min-height: 180px;
        }
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-header {
            background: var(--bg-panel);
            padding: 5px 8px;
            border-bottom: 1px solid var(--border);
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }

        /* LEFT PANEL */
        .left-panel { width: 180px; flex-shrink: 0; }
        .mood-section { margin-bottom: 8px; }
        .mood-title { font-size: 0.55rem; color: var(--text-muted); margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
        .mood-bar-container { height: 6px; background: var(--bg-primary); border-radius: 3px; overflow: hidden; margin-bottom: 2px; }
        .mood-bar { height: 100%; transition: all 0.5s; border-radius: 3px; }
        .mood-bar.happy { background: var(--status-green); }
        .mood-bar.neutral { background: var(--status-yellow); }
        .mood-bar.angry { background: var(--status-orange); }
        .mood-bar.furious { background: var(--status-red); }
        .mood-value { font-size: 0.5rem; color: var(--text-secondary); display: flex; justify-content: space-between; }
        .outage-list { margin-top: 6px; border-top: 1px solid var(--border); padding-top: 6px; }
        .outage-title { font-size: 0.5rem; color: var(--text-muted); margin-bottom: 4px; }
        .outage-item { display: flex; justify-content: space-between; align-items: center; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; font-size: 0.5rem; }
        .outage-item.warn { background: rgba(210,153,34,0.15); color: var(--status-yellow); }
        .outage-item.danger { background: rgba(248,81,73,0.15); color: var(--status-red); }
        .outage-item.ok { background: rgba(63,185,80,0.1); color: var(--status-green); }
        .events-mini { border-top: 1px solid var(--border); margin-top: 6px; padding-top: 6px; }
        .event-item { background: var(--bg-card); padding: 3px 5px; border-radius: 3px; border-left: 2px solid var(--border); margin-bottom: 2px; font-size: 0.5rem; }
        .event-item.alert { border-left-color: var(--status-red); }
        .event-item.warning { border-left-color: var(--status-yellow); }
        .event-item.success { border-left-color: var(--status-green); }
        .event-item.info { border-left-color: var(--accent-cyan); }
        .event-time { color: var(--text-muted); }
        .event-text { color: var(--text-secondary); }

        /* MAP */
        .map-section { flex: 1; position: relative; }
        .map-header { position: absolute; top: 0; left: 0; right: 0; background: rgba(15,19,24,0.9); padding: 4px 8px; display: flex; justify-content: space-between; align-items: center; z-index: 10; border-bottom: 1px solid var(--border); font-size: 0.55rem; }
        .threats-display { display: flex; gap: 10px; }
        .threat-counter { display: flex; align-items: center; gap: 3px; }
        .threat-counter.shahed { color: var(--status-orange); }
        .threat-counter.rocket { color: var(--status-red); }
        .threat-counter.ballistic { color: var(--status-purple); }
        .kyiv-map { width: 100%; height: 100%; }
        .district-shape { fill: rgba(63,185,80,0.1); stroke: var(--status-green); stroke-width: 1.5; cursor: pointer; transition: all 0.2s; }
        .district-shape:hover { fill: rgba(63,185,80,0.2); stroke-width: 2; }
        .district-shape.warning { fill: rgba(210,153,34,0.12); stroke: var(--status-yellow); }
        .district-shape.danger { fill: rgba(248,81,73,0.15); stroke: var(--status-red); }
        .district-label { font-size: 7px; fill: var(--text-secondary); pointer-events: none; text-anchor: middle; }
        .district-power { font-size: 6px; fill: var(--accent-cyan); pointer-events: none; text-anchor: middle; }
        .attack-path { stroke-width: 2; stroke-dasharray: 4,2; fill: none; opacity: 0.7; }
        .attack-path.shahed { stroke: var(--status-orange); }
        .attack-path.rocket { stroke: var(--status-red); }

        /* RIGHT PANEL */
        .right-panel { width: 190px; flex-shrink: 0; }
        .wave-display { padding: 8px; text-align: center; border-bottom: 1px solid var(--border); }
        .wave-number { font-size: 1.4rem; font-weight: 700; color: var(--accent-cyan); }
        .wave-number.danger { color: var(--status-red); }
        .wave-timer { font-size: 0.8rem; color: var(--text-secondary); }
        .wave-phase { font-size: 0.55rem; margin-top: 3px; padding: 2px 8px; border-radius: 8px; display: inline-block; }
        .wave-phase.prep { background: rgba(63,185,80,0.2); color: var(--status-green); }
        .wave-phase.attack { background: rgba(248,81,73,0.2); color: var(--status-red); }
        .threat-slots { padding: 5px; max-height: 60px; overflow-y: auto; border-bottom: 1px solid var(--border); }
        .threat-slot { background: var(--bg-card); border-radius: 3px; padding: 3px 6px; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; font-size: 0.5rem; }
        .threat-icon { font-size: 12px; }
        .threat-name { color: var(--text-primary); }
        .threat-target { color: var(--text-muted); }
        .upgrades-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .upgrade-tab { flex: 1; background: none; border: none; color: var(--text-muted); padding: 5px; cursor: pointer; font-family: inherit; font-size: 0.55rem; border-bottom: 2px solid transparent; }
        .upgrade-tab:hover { color: var(--text-secondary); }
        .upgrade-tab.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }
        .upgrades-list { padding: 5px; }
        .upgrade-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 5px 6px; margin-bottom: 3px; cursor: pointer; font-size: 0.55rem; }
        .upgrade-item:hover:not(.bought):not(.locked) { border-color: var(--accent-cyan); }
        .upgrade-item.bought { border-color: var(--status-green); opacity: 0.6; }
        .upgrade-item.locked { opacity: 0.4; cursor: not-allowed; }
        .upgrade-header { display: flex; justify-content: space-between; }
        .upgrade-name { font-weight: 600; }
        .upgrade-cost { color: #ffd700; }
        .upgrade-desc { font-size: 0.5rem; color: var(--text-muted); margin-top: 2px; }

        /* BOTTOM */
        .bottom-section { flex: 1; display: flex; flex-direction: column; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .controls-header { background: var(--bg-panel); padding: 5px 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 0.6rem; flex-shrink: 0; }
        .controls-header-left { display: flex; align-items: center; gap: 12px; }
        .controls-header-actions { display: flex; gap: 6px; }
        .action-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.55rem; }
        .action-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
        .action-btn.success:hover { border-color: var(--status-green); color: var(--status-green); }
        .action-btn.danger:hover { border-color: var(--status-red); color: var(--status-red); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .legend { display: flex; gap: 10px; font-size: 0.5rem; color: var(--text-muted); }
        .legend-item { display: flex; align-items: center; gap: 3px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
        .legend-dot.on { background: var(--status-green); }
        .legend-dot.off { background: var(--status-yellow); }
        .legend-dot.hot { background: var(--status-orange); }
        .legend-dot.dmg { background: var(--status-red); }
        .subgroups-container { flex: 1; overflow-y: auto; padding: 6px; }
        .subgroups-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(58px, 1fr)); gap: 4px; }
        .subgroup-btn { background: rgba(63,185,80,0.12); border: 1px solid var(--status-green); border-radius: 4px; padding: 4px 2px; cursor: pointer; font-family: inherit; font-size: 0.6rem; font-weight: 600; color: var(--status-green); transition: all 0.1s; display: flex; flex-direction: column; align-items: center; position: relative; min-height: 38px; }
        .subgroup-btn:hover:not(.damaged) { transform: scale(1.03); box-shadow: 0 0 8px rgba(63,185,80,0.3); }
        .subgroup-btn.off { background: rgba(210,153,34,0.12); border-color: var(--status-yellow); color: var(--status-yellow); }
        .subgroup-btn.damaged { background: rgba(248,81,73,0.15); border-color: var(--status-red); color: var(--status-red); cursor: not-allowed; }
        .subgroup-btn.overheated { background: rgba(219,109,40,0.15); border-color: var(--status-orange); color: var(--status-orange); }
        .subgroup-btn.angry { border-color: var(--status-red); box-shadow: 0 0 6px rgba(248,81,73,0.4); }
        .subgroup-id { font-size: 0.65rem; }
        .subgroup-power { font-size: 0.5rem; opacity: 0.8; }
        .subgroup-status { position: absolute; top: 2px; right: 2px; font-size: 8px; }
        .fatigue-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: var(--bg-primary); border-radius: 0 0 3px 3px; }
        .fatigue-fill { height: 100%; transition: width 0.3s, background 0.3s; }
        .fatigue-fill.ok { background: var(--status-green); }
        .fatigue-fill.warn { background: var(--status-yellow); }
        .fatigue-fill.danger { background: var(--status-orange); }
        .fatigue-fill.critical { background: var(--status-red); }

        /* TOOLTIP */
        .tooltip { position: fixed; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 8px; z-index: 100; pointer-events: none; display: none; max-width: 200px; font-size: 0.55rem; }
        .tooltip.active { display: block; }
        .tooltip-title { font-weight: 700; color: var(--accent-cyan); margin-bottom: 4px; }
        .tooltip-row { display: flex; justify-content: space-between; margin: 2px 0; }
        .tooltip-label { color: var(--text-muted); }

        /* OVERLAYS */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 200; }
        .overlay.active { display: flex; }
        .overlay-title { font-size: 2rem; font-weight: 700; margin-bottom: 12px; }
        .overlay-title.defeat { color: var(--status-red); }
        .overlay-title.victory { color: var(--neon-green); }
        .overlay-stats { color: var(--text-secondary); text-align: center; margin-bottom: 20px; line-height: 1.6; }
        .overlay-btn { background: var(--accent-cyan); border: none; color: var(--bg-primary); padding: 10px 30px; border-radius: 6px; font-family: inherit; font-size: 0.85rem; cursor: pointer; }
        .overload-banner { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(248,81,73,0.95); color: white; padding: 14px 28px; border-radius: 8px; font-size: 1rem; font-weight: 700; z-index: 150; display: none; text-align: center; }
        .overload-banner.active { display: block; animation: glow 0.5s infinite; }
        .explosion { position: absolute; width: 30px; height: 30px; border-radius: 50%; background: radial-gradient(circle, rgba(255,200,50,0.9), rgba(248,81,73,0.5) 50%, transparent 70%); animation: explode 0.4s forwards; pointer-events: none; z-index: 25; }
        @keyframes explode { 0% { transform: translate(-50%,-50%) scale(0); opacity: 1; } 100% { transform: translate(-50%,-50%) scale(2.5); opacity: 0; } }

        /* ========== SETTINGS MODAL ========== */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }
        .settings-overlay.active { display: flex; }

        .settings-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            border-radius: 12px 12px 0 0;
        }

        .settings-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .settings-close:hover { background: var(--bg-card); color: var(--text-primary); }

        .settings-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
        }

        .settings-tab {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .settings-tab:hover { color: var(--text-secondary); background: var(--bg-card); }
        .settings-tab.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }
        .settings-tab.debug { color: var(--status-red); }
        .settings-tab.debug.active { border-bottom-color: var(--status-red); }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .settings-section {
            margin-bottom: 16px;
        }

        .settings-section-title {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(48,54,61,0.5);
        }

        .setting-label {
            font-size: 0.75rem;
            color: var(--text-primary);
        }

        .setting-desc {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Select */
        .setting-select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 5px 10px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            min-width: 120px;
        }
        .setting-select:focus { outline: none; border-color: var(--accent-cyan); }

        /* Slider */
        .setting-slider {
            -webkit-appearance: none;
            width: 120px;
            height: 4px;
            background: var(--bg-card);
            border-radius: 2px;
            outline: none;
        }
        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent-cyan);
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-value {
            font-size: 0.7rem;
            color: var(--accent-cyan);
            min-width: 40px;
            text-align: right;
        }

        /* Checkbox */
        .setting-checkbox {
            position: relative;
            width: 36px;
            height: 20px;
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .setting-checkbox.active { background: var(--status-green); }
        .setting-checkbox::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .setting-checkbox.active::after { transform: translateX(16px); }

        /* Custom sliders section */
        .custom-difficulty {
            display: none;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-top: 8px;
        }
        .custom-difficulty.active { display: block; }

        .custom-slider-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        /* Debug warning */
        .debug-warning {
            background: rgba(248,81,73,0.15);
            border: 1px solid var(--status-red);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 12px;
            text-align: center;
        }
        .debug-warning-icon { font-size: 1.5rem; }
        .debug-warning-text { font-size: 0.7rem; color: var(--status-red); margin-top: 4px; }

        /* Cheat buttons */
        .cheat-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-top: 8px;
        }

        .cheat-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.65rem;
            transition: all 0.2s;
        }
        .cheat-btn:hover { border-color: var(--status-purple); color: var(--status-purple); }
        .cheat-btn.danger { border-color: var(--status-red); color: var(--status-red); }
        .cheat-btn.danger:hover { background: rgba(248,81,73,0.2); }

        /* Spawn controls */
        .spawn-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .spawn-input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 5px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.7rem;
            width: 50px;
        }

        .spawn-btn {
            background: var(--status-orange);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.7rem;
        }
        .spawn-btn:hover { background: var(--status-red); }

        /* Settings footer */
        .settings-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            background: var(--bg-panel);
            border-radius: 0 0 12px 12px;
        }

        .settings-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .settings-btn.cancel {
            background: var(--bg-card);
            color: var(--text-secondary);
        }
        .settings-btn.cancel:hover { border-color: var(--text-muted); }

        .settings-btn.apply {
            background: var(--status-green);
            color: white;
            border-color: var(--status-green);
        }
        .settings-btn.apply:hover { background: #45c95a; }

        .settings-btn.save-default {
            background: var(--bg-card);
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        /* FPS Counter */
        .fps-counter {
            position: fixed;
            top: 40px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: var(--neon-green);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            z-index: 100;
            display: none;
        }
        .fps-counter.active { display: block; }

        /* Dev Console */
        .dev-console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: rgba(10,14,20,0.95);
            border-top: 1px solid var(--border);
            z-index: 100;
            display: none;
            flex-direction: column;
        }
        .dev-console.active { display: flex; }
        .console-header {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            font-size: 0.6rem;
        }
        .console-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            font-size: 0.6rem;
            color: var(--text-secondary);
        }
        .console-line { margin-bottom: 2px; }
        .console-line.error { color: var(--status-red); }
        .console-line.warn { color: var(--status-yellow); }
        .console-line.info { color: var(--accent-cyan); }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">–î–¢–ï–ö SIMULATOR</div>
        <div class="header-stats">
            <div class="stat-pill">
                <span class="stat-label">–î–ï–ù–¨</span>
                <span class="stat-value cyan" id="day-num">1</span>
            </div>
            <div class="stat-pill" id="load-pill">
                <span class="stat-label">–ú–ï–†–ï–ñ–ê</span>
                <span class="stat-value green" id="load-value">68%</span>
                <div class="mini-bar"><div class="mini-bar-fill green" id="load-bar" style="width:68%"></div></div>
            </div>
            <div class="stat-pill">
                <span class="stat-label">GEN</span>
                <span class="stat-value cyan" id="gen-value">1200</span>
            </div>
            <div class="stat-pill">
                <span class="stat-value gold">‚Ç¥<span id="money-value">500</span></span>
            </div>
            <div class="stat-pill">
                <span class="stat-value gold" id="reputation">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span>
            </div>
            <div class="header-buttons">
                <button class="btn-sm" onclick="togglePause()" id="pause-btn">‚è∏</button>
                <button class="btn-sm" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <div class="top-section">
            <div class="panel left-panel">
                <div class="panel-header">üìä –ù–ê–°–¢–†–û–á</div>
                <div class="panel-content">
                    <div class="mood-section">
                        <div class="mood-title">üë• –ú–µ—à–∫–∞–Ω—Ü—ñ</div>
                        <div class="mood-bar-container"><div class="mood-bar happy" id="mood-residents" style="width:80%"></div></div>
                        <div class="mood-value"><span id="mood-residents-text">üòä –ó–∞–¥–æ–≤–æ–ª–µ–Ω—ñ</span><span id="mood-residents-val">80%</span></div>
                    </div>
                    <div class="mood-section">
                        <div class="mood-title">üè¢ –ë—ñ–∑–Ω–µ—Å</div>
                        <div class="mood-bar-container"><div class="mood-bar happy" id="mood-business" style="width:75%"></div></div>
                        <div class="mood-value"><span id="mood-business-text">üòä –ó–∞–¥–æ–≤–æ–ª–µ–Ω—ñ</span><span id="mood-business-val">75%</span></div>
                    </div>
                    <div class="mood-section">
                        <div class="mood-title">üè• –ö—Ä–∏—Ç–∏—á–Ω–∞ —ñ–Ω—Ñ—Ä–∞</div>
                        <div class="mood-bar-container"><div class="mood-bar happy" id="mood-critical" style="width:95%"></div></div>
                        <div class="mood-value"><span id="mood-critical-text">‚úì –°—Ç–∞–±—ñ–ª—å–Ω–æ</span><span id="mood-critical-val">95%</span></div>
                    </div>
                    <div class="outage-list">
                        <div class="outage-title">‚è± –î–æ–≤–≥—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:</div>
                        <div id="outage-list"></div>
                    </div>
                    <div class="events-mini">
                        <div class="outage-title">üìã –û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–¥—ñ—ó:</div>
                        <div id="events-list"></div>
                    </div>
                </div>
            </div>

            <div class="panel map-section" id="map-section">
                <div class="map-header">
                    <span>üó∫Ô∏è –ö–ò–á–í</span>
                    <div class="threats-display">
                        <span class="threat-counter shahed">üõ©Ô∏è<span id="cnt-shahed">0</span></span>
                        <span class="threat-counter rocket">üöÄ<span id="cnt-rocket">0</span></span>
                        <span class="threat-counter ballistic">‚òÑÔ∏è<span id="cnt-ball">0</span></span>
                    </div>
                </div>
                <svg class="kyiv-map" viewBox="0 0 500 180" id="kyiv-svg">
                    <path d="M300,0 Q320,60 310,90 Q300,130 320,180" stroke="var(--accent-cyan)" stroke-width="8" fill="none" opacity="0.1"/>
                    <g id="districts-layer"></g>
                    <g id="attacks-layer"></g>
                </svg>
            </div>

            <div class="panel right-panel">
                <div class="panel-header">üéØ –•–í–ò–õ–Ø</div>
                <div class="wave-display">
                    <div class="wave-number" id="wave-num">1</div>
                    <div class="wave-timer" id="wave-timer">0:45</div>
                    <div class="wave-phase prep" id="wave-phase">–ü–Ü–î–ì–û–¢–û–í–ö–ê</div>
                </div>
                <div class="threat-slots" id="threat-slots"></div>
                <div class="upgrades-tabs">
                    <button class="upgrade-tab active" data-tab="infra" onclick="showTab('infra')">üèóÔ∏è–Ü–Ω—Ñ—Ä–∞</button>
                    <button class="upgrade-tab" data-tab="defense" onclick="showTab('defense')">üõ°Ô∏è–ó–∞—Ö–∏—Å—Ç</button>
                </div>
                <div class="panel-content upgrades-list" id="upgrades-list"></div>
            </div>
        </div>

        <div class="bottom-section">
            <div class="controls-header">
                <div class="controls-header-left">
                    <span>‚ö° –ü–Ü–î–ì–†–£–ü–ò</span>
                    <span style="color:var(--accent-cyan)" id="total-power">0 MW</span>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-dot on"></div>ON</div>
                        <div class="legend-item"><div class="legend-dot off"></div>OFF</div>
                        <div class="legend-item"><div class="legend-dot hot"></div>HOT</div>
                        <div class="legend-item"><div class="legend-dot dmg"></div>DMG</div>
                    </div>
                </div>
                <div class="controls-header-actions">
                    <button class="action-btn success" onclick="enableAll()">‚úì –í—Å–µ ON</button>
                    <button class="action-btn" onclick="useReserve()" id="reserve-btn" disabled>üîã+300</button>
                    <button class="action-btn danger" onclick="emergencyOff()">‚ö†-5</button>
                    <button class="action-btn" onclick="rotateGroups()">üîÑ –†–æ—Ç–∞—Ü—ñ—è</button>
                </div>
            </div>
            <div class="subgroups-container">
                <div class="subgroups-grid" id="subgroups-grid"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-overlay" id="settings-overlay" onclick="closeSettingsOutside(event)">
        <div class="settings-modal" onclick="event.stopPropagation()">
            <div class="settings-header">
                <span class="settings-title">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span>
                <button class="settings-close" onclick="closeSettings()">‚úï</button>
            </div>
            
            <div class="settings-tabs">
                <button class="settings-tab active" data-stab="game" onclick="showSettingsTab('game')">üéÆ –ì—Ä–∞</button>
                <button class="settings-tab" data-stab="graphics" onclick="showSettingsTab('graphics')">üñ•Ô∏è –ì—Ä–∞—Ñ—ñ–∫–∞</button>
                <button class="settings-tab debug" data-stab="debug" onclick="showSettingsTab('debug')" id="debug-tab" style="display:none">üîß –î–µ–±–∞–≥</button>
            </div>

            <div class="settings-content" id="settings-content">
                <!-- Game Tab -->
                <div class="settings-tab-content" id="tab-game">
                    <div class="settings-section">
                        <div class="settings-section-title">–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å</div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–†—ñ–≤–µ–Ω—å —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ</div>
                                <div class="setting-desc">–í–ø–ª–∏–≤–∞—î –Ω–∞ —á–∞—Å—Ç–æ—Ç—É –∞—Ç–∞–∫ —Ç–∞ —à–∫–æ–¥—É</div>
                            </div>
                            <select class="setting-select" id="difficulty" onchange="onDifficultyChange()">
                                <option value="easy">–õ–µ–≥–∫–∞</option>
                                <option value="normal" selected>–ù–æ—Ä–º–∞–ª—å–Ω–∞</option>
                                <option value="hard">–í–∞–∂–∫–∞</option>
                                <option value="custom">–ö–∞—Å—Ç–æ–º</option>
                            </select>
                        </div>
                        <div class="custom-difficulty" id="custom-difficulty">
                            <div class="custom-slider-row">
                                <span class="setting-label">–ß–∞—Å—Ç–æ—Ç–∞ –∞—Ç–∞–∫</span>
                                <div class="setting-control">
                                    <input type="range" class="setting-slider" id="attack-freq" min="50" max="200" value="100">
                                    <span class="slider-value" id="attack-freq-val">100%</span>
                                </div>
                            </div>
                            <div class="custom-slider-row">
                                <span class="setting-label">–®–∫–æ–¥–∞ –≤–æ—Ä–æ–≥—ñ–≤</span>
                                <div class="setting-control">
                                    <input type="range" class="setting-slider" id="enemy-dmg" min="50" max="200" value="100">
                                    <span class="slider-value" id="enemy-dmg-val">100%</span>
                                </div>
                            </div>
                            <div class="custom-slider-row">
                                <span class="setting-label">–ß–∞—Å —Ä–µ–º–æ–Ω—Ç—É</span>
                                <div class="setting-control">
                                    <input type="range" class="setting-slider" id="repair-time" min="50" max="200" value="100">
                                    <span class="slider-value" id="repair-time-val">100%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">–®–≤–∏–¥–∫—ñ—Å—Ç—å</div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–®–≤–∏–¥–∫—ñ—Å—Ç—å –≥—Ä–∏</div>
                                <div class="setting-desc">–ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è —ñ–≥—Ä–æ–≤–æ–≥–æ —á–∞—Å—É</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" class="setting-slider" id="game-speed" min="25" max="200" value="100" step="25">
                                <span class="slider-value" id="game-speed-val">1x</span>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è</div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–ê–≤—Ç–æ–ø–∞—É–∑–∞ –ø—Ä–∏ –∑–∞–≥—Ä–æ–∑–∞—Ö</div>
                                <div class="setting-desc">–ü–∞—É–∑–∞ –ø—Ä–∏ –ø–æ—á–∞—Ç–∫—É —Ö–≤–∏–ª—ñ</div>
                            </div>
                            <div class="setting-checkbox" id="autopause" onclick="toggleCheckbox(this)"></div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è</div>
                            </div>
                            <select class="setting-select" id="autosave">
                                <option value="off">–í–∏–º–∫–Ω–µ–Ω–æ</option>
                                <option value="5">–ö–æ–∂–Ω—ñ 5 —Ö–≤</option>
                                <option value="15" selected>–ö–æ–∂–Ω—ñ 15 —Ö–≤</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Graphics Tab -->
                <div class="settings-tab-content" id="tab-graphics" style="display:none">
                    <div class="settings-section">
                        <div class="settings-section-title">–Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–ú–∞—Å—à—Ç–∞–± UI</div>
                                <div class="setting-desc">–†–æ–∑–º—ñ—Ä –≤—Å—å–æ–≥–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" class="setting-slider" id="ui-scale" min="75" max="150" value="100" step="5">
                                <span class="slider-value" id="ui-scale-val">100%</span>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—ñ–≤</div>
                            </div>
                            <select class="setting-select" id="font-size">
                                <option value="small">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
                                <option value="normal" selected>–ù–æ—Ä–º–∞–ª—å–Ω–∏–π</option>
                                <option value="large">–í–µ–ª–∏–∫–∏–π</option>
                                <option value="extra">–ï–∫—Å—Ç—Ä–∞</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                                <div class="setting-desc">–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ü–∏—Ñ—Ä–∏</div>
                            </div>
                            <div class="setting-checkbox" id="detailed-stats" onclick="toggleCheckbox(this)"></div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–¢—É–ª—Ç—ñ–ø–∏ –ø—ñ–¥–≥—Ä—É–ø</div>
                                <div class="setting-desc">–í—É–ª–∏—Ü—ñ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ</div>
                            </div>
                            <div class="setting-checkbox active" id="show-tooltips" onclick="toggleCheckbox(this)"></div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–Ø–∫—ñ—Å—Ç—å –≥—Ä–∞—Ñ—ñ–∫–∏</div>
                            </div>
                            <select class="setting-select" id="gfx-quality">
                                <option value="low">–ù–∏–∑—å–∫–∞</option>
                                <option value="medium" selected>–°–µ—Ä–µ–¥–Ω—è</option>
                                <option value="high">–í–∏—Å–æ–∫–∞</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">FPS –ª—ñ–º—ñ—Ç</div>
                            </div>
                            <div class="setting-control">
                                <input type="range" class="setting-slider" id="fps-limit" min="30" max="120" value="60" step="10">
                                <span class="slider-value" id="fps-limit-val">60</span>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–ü–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–∏–π —Ä–µ–∂–∏–º</div>
                            </div>
                            <button class="action-btn" onclick="toggleFullscreen()">–£–≤—ñ–º–∫–Ω—É—Ç–∏</button>
                        </div>
                    </div>
                </div>

                <!-- Debug Tab -->
                <div class="settings-tab-content" id="tab-debug" style="display:none">
                    <div class="debug-warning">
                        <div class="debug-warning-icon">‚ö†Ô∏è</div>
                        <div class="debug-warning-text">–¢—ñ–ª—å–∫–∏ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è! –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —á—ñ—Ç—ñ–≤ –≤–∏–º–∫–Ω–µ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è.</div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">–†–µ–∂–∏–º–∏</div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">–†–µ–∂–∏–º –ë–æ–≥–∞</div>
                                <div class="setting-desc">–ù–µ–≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å, –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–∞ –µ–Ω–µ—Ä–≥—ñ—è</div>
                            </div>
                            <div class="setting-checkbox" id="god-mode" onclick="toggleCheckbox(this)"></div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">FPS Counter</div>
                            </div>
                            <div class="setting-checkbox" id="fps-counter" onclick="toggleCheckbox(this); toggleFPS()"></div>
                        </div>
                        <div class="setting-row">
                            <div>
                                <div class="setting-label">Dev Console</div>
                            </div>
                            <div class="setting-checkbox" id="dev-console" onclick="toggleCheckbox(this); toggleConsole()"></div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">–®–≤–∏–¥–∫–∏–π —Å–ø–∞–≤–Ω –≤–æ—Ä–æ–≥–∞</div>
                        <div class="setting-row">
                            <select class="setting-select" id="spawn-type" style="min-width:150px">
                                <option value="shahed136">–®–∞—Ö–µ–¥-136</option>
                                <option value="geran2">–ì–µ—Ä–∞–Ω-2</option>
                                <option value="swarm">–†—ñ–π –¥—Ä–æ–Ω—ñ–≤</option>
                                <option value="kalibr">–ö–∞–ª—ñ–±—Ä</option>
                                <option value="x101">–•-101</option>
                                <option value="iskander">–Ü—Å–∫–∞–Ω–¥–µ—Ä</option>
                                <option value="kinzhal">–ö–∏–Ω–¥–∂–∞–ª</option>
                            </select>
                            <div class="spawn-controls">
                                <input type="number" class="spawn-input" id="spawn-count" value="3" min="1" max="50">
                                <button class="spawn-btn" onclick="debugSpawn()">–°–ø–∞–≤–Ω</button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">–ß—ñ—Ç–∏</div>
                        <div class="cheat-buttons">
                            <button class="cheat-btn" onclick="cheat('money')">+10k ‚Ç¥</button>
                            <button class="cheat-btn" onclick="cheat('reputation')">Max –†–µ–ø—É—Ç–∞—Ü—ñ—è</button>
                            <button class="cheat-btn" onclick="cheat('unlock')">Unlock All</button>
                            <button class="cheat-btn" onclick="cheat('repair')">–†–µ–º–æ–Ω—Ç –≤—Å—å–æ–≥–æ</button>
                            <button class="cheat-btn" onclick="cheat('cooldown')">–°–∫–∏–Ω—É—Ç–∏ –Ω–∞–≥—Ä—ñ–≤</button>
                            <button class="cheat-btn" onclick="cheat('skip')">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ —Ö–≤–∏–ª—é</button>
                        </div>
                        <div style="margin-top:12px">
                            <button class="cheat-btn danger" onclick="cheat('reset')" style="width:100%">üîÑ –û–±–Ω—É–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—ñ–≤ (—Å–∫–∏–¥–∞–Ω–Ω—è –≥—Ä–∏)</button>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">–®–≤–∏–¥–∫–∏–π —á–∞—Å</div>
                        <div class="setting-row">
                            <div class="setting-label">–ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è (–¥–æ 100x)</div>
                            <div class="setting-control">
                                <input type="range" class="setting-slider" id="time-accel" min="1" max="100" value="1">
                                <span class="slider-value" id="time-accel-val">1x</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-footer">
                <button class="settings-btn save-default" onclick="saveAsDefault()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ –¥–µ—Ñ–æ–ª—Ç</button>
                <button class="settings-btn cancel" onclick="closeSettings()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="settings-btn apply" onclick="applySettings()">‚úì –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- FPS Counter -->
    <div class="fps-counter" id="fps-display">FPS: 60</div>

    <!-- Dev Console -->
    <div class="dev-console" id="dev-console-panel">
        <div class="console-header">
            <span>üîß Developer Console</span>
            <button class="btn-sm" onclick="clearConsole()">Clear</button>
        </div>
        <div class="console-content" id="console-content"></div>
    </div>

    <div class="tooltip" id="tooltip"></div>
    <div class="overlay" id="game-overlay">
        <div class="overlay-title" id="overlay-title">–ë–õ–ï–ö–ê–£–¢</div>
        <div class="overlay-stats" id="overlay-stats"></div>
        <button class="overlay-btn" onclick="location.reload()">üîÑ –ó–Ω–æ–≤—É</button>
    </div>
    <div class="overload-banner" id="overload-banner">‚ö†Ô∏è –ü–ï–†–ï–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø!</div>

<script>
// ========== SETTINGS ==========
const Settings = {
    difficulty: 'normal',
    attackFreq: 100,
    enemyDmg: 100,
    repairTimeMod: 100,
    gameSpeed: 100,
    autopause: false,
    autosave: '15',
    uiScale: 100,
    fontSize: 'normal',
    detailedStats: false,
    showTooltips: true,
    gfxQuality: 'medium',
    fpsLimit: 60,
    godMode: false,
    fpsCounter: false,
    devConsole: false,
    timeAccel: 1
};

let devMode = false;

// Check for dev mode (Ctrl+Shift+D)
document.addEventListener('keydown', e => {
    if(e.ctrlKey && e.shiftKey && e.key === 'D'){
        devMode = !devMode;
        document.getElementById('debug-tab').style.display = devMode ? 'block' : 'none';
        consoleLog(devMode ? 'Dev mode enabled' : 'Dev mode disabled', 'info');
    }
});

function openSettings(){
    document.getElementById('settings-overlay').classList.add('active');
    G.paused = true;
    document.getElementById('pause-btn').textContent = '‚ñ∂';
}

function closeSettings(){
    document.getElementById('settings-overlay').classList.remove('active');
}

function closeSettingsOutside(e){
    if(e.target.id === 'settings-overlay') closeSettings();
}

function showSettingsTab(tab){
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.toggle('active', t.dataset.stab === tab));
    document.querySelectorAll('.settings-tab-content').forEach(c => c.style.display = 'none');
    document.getElementById('tab-' + tab).style.display = 'block';
}

function toggleCheckbox(el){
    el.classList.toggle('active');
}

function onDifficultyChange(){
    const val = document.getElementById('difficulty').value;
    document.getElementById('custom-difficulty').classList.toggle('active', val === 'custom');
}

function applySettings(){
    // Game settings
    Settings.difficulty = document.getElementById('difficulty').value;
    Settings.gameSpeed = parseInt(document.getElementById('game-speed').value);
    Settings.autopause = document.getElementById('autopause').classList.contains('active');
    Settings.autosave = document.getElementById('autosave').value;
    
    if(Settings.difficulty === 'custom'){
        Settings.attackFreq = parseInt(document.getElementById('attack-freq').value);
        Settings.enemyDmg = parseInt(document.getElementById('enemy-dmg').value);
        Settings.repairTimeMod = parseInt(document.getElementById('repair-time').value);
    } else {
        const presets = { easy: [70,70,70], normal: [100,100,100], hard: [150,150,130] };
        [Settings.attackFreq, Settings.enemyDmg, Settings.repairTimeMod] = presets[Settings.difficulty] || presets.normal;
    }
    
    // Graphics settings
    Settings.uiScale = parseInt(document.getElementById('ui-scale').value);
    Settings.fontSize = document.getElementById('font-size').value;
    Settings.detailedStats = document.getElementById('detailed-stats').classList.contains('active');
    Settings.showTooltips = document.getElementById('show-tooltips').classList.contains('active');
    Settings.gfxQuality = document.getElementById('gfx-quality').value;
    Settings.fpsLimit = parseInt(document.getElementById('fps-limit').value);
    
    // Debug settings
    if(devMode){
        Settings.godMode = document.getElementById('god-mode').classList.contains('active');
        Settings.timeAccel = parseInt(document.getElementById('time-accel').value);
    }
    
    // Apply UI scale
    document.documentElement.style.setProperty('--ui-scale', Settings.uiScale / 100);
    
    // Apply font size
    const fontSizes = { small: 10, normal: 12, large: 14, extra: 16 };
    document.body.style.fontSize = (fontSizes[Settings.fontSize] * Settings.uiScale / 100) + 'px';
    
    consoleLog('Settings applied', 'info');
    closeSettings();
}

function saveAsDefault(){
    localStorage.setItem('dtek-settings', JSON.stringify(Settings));
    consoleLog('Settings saved as default', 'info');
    alert('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
}

function loadSettings(){
    const saved = localStorage.getItem('dtek-settings');
    if(saved){
        Object.assign(Settings, JSON.parse(saved));
        applySettings();
    }
}

// Update slider values
document.querySelectorAll('.setting-slider').forEach(slider => {
    slider.addEventListener('input', function(){
        const valEl = document.getElementById(this.id + '-val');
        if(valEl){
            if(this.id === 'game-speed'){
                valEl.textContent = (this.value / 100).toFixed(2) + 'x';
            } else if(this.id === 'time-accel'){
                valEl.textContent = this.value + 'x';
            } else if(this.id === 'fps-limit'){
                valEl.textContent = this.value;
            } else {
                valEl.textContent = this.value + '%';
            }
        }
    });
});

// ========== DEBUG FUNCTIONS ==========
let fpsFrames = 0;
let fpsLastTime = performance.now();

function toggleFPS(){
    Settings.fpsCounter = document.getElementById('fps-counter').classList.contains('active');
    document.getElementById('fps-display').classList.toggle('active', Settings.fpsCounter);
}

function toggleConsole(){
    Settings.devConsole = document.getElementById('dev-console').classList.contains('active');
    document.getElementById('dev-console-panel').classList.toggle('active', Settings.devConsole);
}

function consoleLog(msg, type = 'info'){
    if(!Settings.devConsole) return;
    const content = document.getElementById('console-content');
    const time = new Date().toLocaleTimeString();
    content.insertAdjacentHTML('beforeend', `<div class="console-line ${type}">[${time}] ${msg}</div>`);
    content.scrollTop = content.scrollHeight;
}

function clearConsole(){
    document.getElementById('console-content').innerHTML = '';
}

function debugSpawn(){
    const type = document.getElementById('spawn-type').value;
    const count = parseInt(document.getElementById('spawn-count').value) || 1;
    for(let i = 0; i < count; i++){
        const tmpl = THREATS.find(t => t.id === type) || THREATS[0];
        const targetId = DISTRICTS[Math.floor(Math.random() * DISTRICTS.length)].id;
        const target = DISTRICTS.find(d => d.id === targetId);
        G.wave.threats.push({
            id: Date.now() + Math.random(),
            ...tmpl,
            targetId,
            x: -20, y: Math.random() * 180,
            tx: target.x, ty: target.y,
            progress: 0
        });
    }
    consoleLog(`Spawned ${count}x ${type}`, 'warn');
}

function cheat(type){
    switch(type){
        case 'money': G.money += 10000; break;
        case 'reputation': G.mood = { residents: 100, business: 100, critical: 100 }; break;
        case 'unlock': UPGRADES.infra.forEach(u => { G.boughtUpgrades.add(u.id); u.effect(); }); 
                       UPGRADES.defense.forEach(u => { G.boughtUpgrades.add(u.id); u.effect(); }); break;
        case 'repair': G.subgroups.forEach(s => { if(s.status==='damaged'){ s.status='on'; s.heat=0; G.consumption+=s.power; }}); break;
        case 'cooldown': G.subgroups.forEach(s => s.heat = 0); break;
        case 'skip': endWave(); break;
        case 'reset': location.reload(); break;
    }
    consoleLog(`Cheat: ${type}`, 'warn');
    renderSubgroups();
    renderUpgrades();
    updateUI();
}

function toggleFullscreen(){
    if(!document.fullscreenElement){
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// FPS counter update
function updateFPS(){
    fpsFrames++;
    const now = performance.now();
    if(now - fpsLastTime >= 1000){
        document.getElementById('fps-display').textContent = 'FPS: ' + fpsFrames;
        fpsFrames = 0;
        fpsLastTime = now;
    }
    requestAnimationFrame(updateFPS);
}
updateFPS();

// ========== GAME DATA ==========
const THREATS = [
    { id:'shahed136', name:'–®–∞—Ö–µ–¥-136', icon:'üõ©Ô∏è', type:'shahed', speed:0.015, dmg:1, wave:1 },
    { id:'geran2', name:'–ì–µ—Ä–∞–Ω-2', icon:'üõ©Ô∏è', type:'shahed', speed:0.02, dmg:1, wave:2 },
    { id:'swarm', name:'–†—ñ–π –¥—Ä–æ–Ω—ñ–≤', icon:'ü¶ü', type:'shahed', speed:0.012, dmg:2, wave:4 },
    { id:'kalibr', name:'–ö–∞–ª—ñ–±—Ä', icon:'üöÄ', type:'rocket', speed:0.045, dmg:2, wave:3 },
    { id:'x101', name:'–•-101', icon:'üöÄ', type:'rocket', speed:0.05, dmg:2, wave:5 },
    { id:'iskander', name:'–Ü—Å–∫–∞–Ω–¥–µ—Ä', icon:'‚òÑÔ∏è', type:'ballistic', speed:0.08, dmg:3, wave:7 },
    { id:'kinzhal', name:'–ö–∏–Ω–¥–∂–∞–ª', icon:'‚ö°', type:'ballistic', speed:0.12, dmg:4, wave:9 }
];

const UPGRADES = {
    infra: [
        { id:'gen1', name:'‚ö° +100 MW', desc:'–ú–æ–¥–µ—Ä–Ω—ñ–∑–∞—Ü—ñ—è –¢–ï–¶', cost:80, effect:()=>G.generation+=100 },
        { id:'gen2', name:'üîã –†–µ–∑–µ—Ä–≤', desc:'–ö–Ω–æ–ø–∫–∞ +300MW', cost:120, effect:()=>G.hasReserve=true },
        { id:'gen3', name:'üöõ +150 MW', desc:'–ú–æ–±—ñ–ª—å–Ω—ñ –¥–∏–∑–µ–ª—ñ', cost:200, effect:()=>G.generation+=150 },
        { id:'auto', name:'üîÑ –ê–≤—Ç–æ-–±–∞–ª–∞–Ω—Å', desc:'–ê–≤—Ç–æ –ø—Ä–∏ 92%', cost:250, effect:()=>G.hasAuto=true },
        { id:'cool', name:'‚ùÑÔ∏è –û—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è', desc:'-40% –ø–µ—Ä–µ–≥—Ä—ñ–≤—É', cost:180, effect:()=>G.coolBonus+=0.4 },
        { id:'gen4', name:'üè≠ +300 MW', desc:'–°—É–ø–µ—Ä-–¢–ï–¶', cost:400, effect:()=>G.generation+=300 }
    ],
    defense: [
        { id:'reb', name:'üì° –†–ï–ë', desc:'-25% —à–∞—Ö–µ–¥—ñ–≤', cost:120, effect:()=>G.shahedDef+=0.25 },
        { id:'repair', name:'üîß –†–µ–º–æ–Ω—Ç 15—Å', desc:'–®–≤–∏–¥–∫—ñ –±—Ä–∏–≥–∞–¥–∏', cost:150, effect:()=>G.repairTime=15 },
        { id:'ppo', name:'üöÄ –ü–ü–û', desc:'-25% —Ä–∞–∫–µ—Ç', cost:250, effect:()=>G.rocketDef+=0.25 },
        { id:'cable', name:'üîå –ö–∞–±–µ–ª—ñ', desc:'-30% –ø–æ—à–∫–æ–¥–∂–µ–Ω—å', cost:300, effect:()=>G.dmgReduction+=0.3 },
        { id:'air', name:'‚úàÔ∏è –©–∏—Ç', desc:'-20% –≤—Å—ñ—Ö', cost:450, effect:()=>G.globalDef+=0.2 }
    ]
};

const DISTRICTS = [
    { id:'obolon', name:'–û–±–æ–ª–æ–Ω—å', short:'–û–ë–õ', power:140, x:130, y:32, subs:4 },
    { id:'podil', name:'–ü–æ–¥—ñ–ª', short:'–ü–î–õ', power:100, x:200, y:45, subs:3 },
    { id:'shevchenko', name:'–®–µ–≤—á–µ–Ω–∫–æ', short:'–®–í–ß', power:130, x:120, y:80, subs:4 },
    { id:'pechersk', name:'–ü–µ—á–µ—Ä—Å—å–∫', short:'–ü–ß–†', power:150, x:235, y:90, subs:4 },
    { id:'sviatoshyn', name:'–°–≤—è—Ç–æ—à–∏–Ω', short:'–°–í–¢', power:110, x:45, y:72, subs:3 },
    { id:'solomianka', name:"–°–æ–ª–æ–º'—è–Ω–∫–∞", short:'–°–õ–ú', power:95, x:85, y:130, subs:3 },
    { id:'holosiiv', name:'–ì–æ–ª–æ—Å—ñ—ó–≤', short:'–ì–õ–°', power:105, x:175, y:145, subs:3 },
    { id:'desnianskyi', name:'–î–µ—Å–Ω—è–Ω—Å—å–∫–∏–π', short:'–î–°–ù', power:135, x:370, y:35, subs:4 },
    { id:'dnipro', name:'–î–Ω—ñ–ø—Ä–æ–≤—Å—å–∫–∏–π', short:'–î–ù–ü', power:115, x:395, y:95, subs:3 },
    { id:'darnytsia', name:'–î–∞—Ä–Ω–∏—Ü—è', short:'–î–†–ù', power:125, x:440, y:140, subs:4 }
];

// ========== STATE ==========
const G = {
    paused: false,
    gameOver: false,
    day: 1,
    generation: 1200,
    consumption: 780,
    load: 65,
    maxLoad: 65,
    money: 500,
    mood: { residents: 80, business: 75, critical: 95 },
    repairTime: 35,
    hasReserve: false,
    hasAuto: false,
    coolBonus: 0,
    shahedDef: 0,
    rocketDef: 0,
    globalDef: 0,
    dmgReduction: 0,
    wave: { num:1, phase:'prep', time:45, threats:[] },
    subgroups: [],
    boughtUpgrades: new Set(),
    currentTab: 'infra'
};

let subId = 1;
DISTRICTS.forEach(d => {
    for(let i = 1; i <= d.subs; i++){
        G.subgroups.push({ id: subId++, districtId: d.id, districtName: d.name, districtShort: d.short, num: i, power: Math.round(d.power / d.subs), status: 'on', onTime: 0, offTime: 0, heat: 0 });
    }
});

// ========== RENDER ==========
function renderMap(){
    const layer = document.getElementById('districts-layer');
    layer.innerHTML = '';
    DISTRICTS.forEach(d => {
        const subs = G.subgroups.filter(s => s.districtId === d.id);
        const hasDmg = subs.some(s => s.status === 'damaged');
        const hasOff = subs.some(s => s.status === 'off');
        const curPower = subs.filter(s => s.status === 'on').reduce((a,s) => a + s.power, 0);
        let cls = 'district-shape';
        if(hasDmg) cls += ' danger';
        else if(hasOff) cls += ' warning';
        const size = 22 + d.power/15;
        const path = `M${d.x},${d.y-size/2} L${d.x+size/2},${d.y} L${d.x},${d.y+size/2} L${d.x-size/2},${d.y} Z`;
        const shape = document.createElementNS('http://www.w3.org/2000/svg','path');
        shape.setAttribute('d', path);
        shape.setAttribute('class', cls);
        shape.id = 'map-'+d.id;
        layer.appendChild(shape);
        const label = document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('x', d.x);
        label.setAttribute('y', d.y - 1);
        label.setAttribute('class', 'district-label');
        label.textContent = d.short;
        layer.appendChild(label);
        const power = document.createElementNS('http://www.w3.org/2000/svg','text');
        power.setAttribute('x', d.x);
        power.setAttribute('y', d.y + 8);
        power.setAttribute('class', 'district-power');
        power.textContent = curPower;
        power.id = 'power-'+d.id;
        layer.appendChild(power);
    });
}

function renderSubgroups(){
    const grid = document.getElementById('subgroups-grid');
    let total = 0;
    grid.innerHTML = G.subgroups.map(s => {
        if(s.status === 'on') total += s.power;
        let cls = 'subgroup-btn ' + s.status;
        let statusIcon = '';
        if(s.status === 'on' && s.heat >= 70){ cls = 'subgroup-btn overheated'; statusIcon = 'üî•'; }
        if(s.status === 'off' && s.offTime > 90){ cls += ' angry'; statusIcon = 'üò°'; }
        else if(s.status === 'off' && s.offTime > 45){ statusIcon = 'üòê'; }
        const heatPct = Math.min(100, s.heat);
        let heatCls = heatPct >= 70 ? 'critical' : heatPct >= 50 ? 'danger' : heatPct >= 30 ? 'warn' : 'ok';
        return `<button class="${cls}" onclick="toggleSubgroup(${s.id})" onmouseenter="showTip(event,${s.id})" onmouseleave="hideTip()" ${s.status==='damaged'?'disabled':''}>
            <span class="subgroup-status">${statusIcon}</span>
            <span class="subgroup-id">${s.districtShort}-${s.num}</span>
            <span class="subgroup-power">${s.power}MW</span>
            <div class="fatigue-bar"><div class="fatigue-fill ${heatCls}" style="width:${heatPct}%"></div></div>
        </button>`;
    }).join('');
    document.getElementById('total-power').textContent = total + ' MW';
}

function renderOutages(){
    const list = document.getElementById('outage-list');
    const longOff = G.subgroups.filter(s => s.status === 'off' && s.offTime > 30).sort((a,b) => b.offTime - a.offTime).slice(0, 5);
    if(longOff.length === 0){ list.innerHTML = '<div class="outage-item ok">‚úì –ù–µ–º–∞—î</div>'; return; }
    list.innerHTML = longOff.map(s => {
        const min = Math.floor(s.offTime / 60);
        const sec = s.offTime % 60;
        const cls = s.offTime > 90 ? 'danger' : 'warn';
        const emoji = s.offTime > 90 ? 'üò°' : 'üòê';
        return `<div class="outage-item ${cls}"><span>${s.districtShort}-${s.num}</span><span>${emoji} ${min}:${String(sec).padStart(2,'0')}</span></div>`;
    }).join('');
}

function renderMood(){
    const offGroups = G.subgroups.filter(s => s.status === 'off');
    const longOff = offGroups.filter(s => s.offTime > 60).length;
    const veryLongOff = offGroups.filter(s => s.offTime > 120).length;
    const damaged = G.subgroups.filter(s => s.status === 'damaged').length;
    G.mood.residents = Math.max(10, 100 - longOff * 8 - veryLongOff * 15 - damaged * 5);
    G.mood.business = Math.max(10, 100 - offGroups.length * 3 - damaged * 8);
    G.mood.critical = Math.max(20, 100 - damaged * 12);
    ['residents', 'business', 'critical'].forEach(type => {
        const val = G.mood[type];
        const bar = document.getElementById('mood-' + type);
        const text = document.getElementById('mood-' + type + '-text');
        const valEl = document.getElementById('mood-' + type + '-val');
        bar.style.width = val + '%';
        valEl.textContent = Math.round(val) + '%';
        let cls, emoji, txt;
        if(val >= 70){ cls='happy'; emoji='üòä'; txt='–ó–∞–¥–æ–≤–æ–ª–µ–Ω—ñ'; }
        else if(val >= 50){ cls='neutral'; emoji='üòê'; txt='–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ'; }
        else if(val >= 30){ cls='angry'; emoji='üò†'; txt='–ù–µ–∑–∞–¥–æ–≤–æ–ª–µ–Ω—ñ'; }
        else { cls='furious'; emoji='üò°'; txt='–ü—Ä–æ—Ç–µ—Å—Ç–∏!'; }
        bar.className = 'mood-bar ' + cls;
        text.textContent = emoji + ' ' + txt;
    });
    if(G.mood.residents < 15 && !Settings.godMode){
        addEvent('alert', 'üò° –ú–ê–°–û–í–Ü –ü–†–û–¢–ï–°–¢–ò!');
        setTimeout(gameOver, 500);
    }
}

function renderThreats(){
    const slots = document.getElementById('threat-slots');
    if(G.wave.threats.length === 0){ slots.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:5px">‚Äî</div>'; return; }
    slots.innerHTML = G.wave.threats.slice(0,3).map(t => {
        const dist = DISTRICTS.find(d => d.id === t.targetId);
        return `<div class="threat-slot"><span class="threat-icon">${t.icon}</span><span class="threat-name">${t.name}</span><span class="threat-target">‚Üí${dist?.short||'?'}</span></div>`;
    }).join('');
}

function renderUpgrades(){
    const list = document.getElementById('upgrades-list');
    const ups = UPGRADES[G.currentTab] || [];
    list.innerHTML = ups.map(u => {
        const bought = G.boughtUpgrades.has(u.id);
        const canBuy = G.money >= u.cost && !bought;
        let cls = 'upgrade-item';
        if(bought) cls += ' bought';
        else if(!canBuy) cls += ' locked';
        return `<div class="${cls}" onclick="buyUpgrade('${u.id}')"><div class="upgrade-header"><span class="upgrade-name">${u.name}</span><span class="upgrade-cost">${bought?'‚úì':u.cost}</span></div><div class="upgrade-desc">${u.desc}</div></div>`;
    }).join('');
}

function showTab(tab){
    G.currentTab = tab;
    document.querySelectorAll('.upgrade-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    renderUpgrades();
}

function showTip(e, id){
    if(!Settings.showTooltips) return;
    const s = G.subgroups.find(x => x.id === id);
    if(!s) return;
    const tip = document.getElementById('tooltip');
    const heatSt = s.heat >= 70 ? 'üî•–ö—Ä–∏—Ç–∏—á–Ω–æ!' : s.heat >= 40 ? '‚ö†Ô∏è–í–∏—Å–æ–∫–∏–π' : '‚úì–ù–æ—Ä–º–∞';
    const offSt = s.offTime > 90 ? 'üò°–°–∫–∞—Ä–≥–∏!' : s.offTime > 45 ? 'üòê–ù–µ–∑–∞–¥–æ–≤.' : '‚úì–ù–æ—Ä–º–∞';
    tip.innerHTML = `<div class="tooltip-title">${s.districtName} - –ì—Ä—É–ø–∞ ${s.num}</div>
        <div class="tooltip-row"><span class="tooltip-label">–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å:</span><span>${s.power} MW</span></div>
        <div class="tooltip-row"><span class="tooltip-label">–°—Ç–∞—Ç—É—Å:</span><span>${s.status==='on'?'üü¢ON':s.status==='off'?'üü°OFF':'üî¥DMG'}</span></div>
        <div class="tooltip-row"><span class="tooltip-label">–ù–∞–≥—Ä—ñ–≤:</span><span>${Math.round(s.heat)}% ${heatSt}</span></div>
        ${s.status==='off'?`<div class="tooltip-row"><span class="tooltip-label">–ë–µ–∑ —Å–≤—ñ—Ç–ª–∞:</span><span>${Math.floor(s.offTime/60)}:${String(s.offTime%60).padStart(2,'0')} ${offSt}</span></div>`:''}`;
    tip.style.left = (e.clientX + 10) + 'px';
    tip.style.top = (e.clientY + 10) + 'px';
    tip.classList.add('active');
}
function hideTip(){ document.getElementById('tooltip').classList.remove('active'); }

function updateUI(){
    G.load = Math.round((G.consumption / G.generation) * 100);
    G.maxLoad = Math.max(G.maxLoad, G.load);
    const loadEl = document.getElementById('load-value');
    const loadBar = document.getElementById('load-bar');
    const loadPill = document.getElementById('load-pill');
    loadEl.textContent = G.load + '%';
    loadBar.style.width = Math.min(100, G.load) + '%';
    const cls = G.load >= 88 ? 'red' : G.load >= 70 ? 'yellow' : 'green';
    loadEl.className = 'stat-value ' + cls;
    loadBar.className = 'mini-bar-fill ' + cls;
    loadPill.classList.toggle('danger', G.load >= 88);
    document.getElementById('gen-value').textContent = G.generation;
    document.getElementById('money-value').textContent = G.money;
    document.getElementById('day-num').textContent = G.day;
    const rep = Math.round((G.mood.residents + G.mood.business + G.mood.critical) / 60);
    document.getElementById('reputation').textContent = '‚òÖ'.repeat(Math.min(5,rep)) + '‚òÜ'.repeat(Math.max(0,5-rep));
    const w = G.wave;
    document.getElementById('wave-num').textContent = w.num;
    document.getElementById('wave-num').classList.toggle('danger', w.phase === 'attack');
    document.getElementById('wave-timer').textContent = `${Math.floor(w.time/60)}:${String(w.time%60).padStart(2,'0')}`;
    const phase = document.getElementById('wave-phase');
    phase.textContent = w.phase === 'prep' ? '–ü–Ü–î–ì–û–¢–û–í–ö–ê' : '–ê–¢–ê–ö–ê!';
    phase.className = 'wave-phase ' + w.phase;
    document.getElementById('cnt-shahed').textContent = w.threats.filter(t=>t.type==='shahed').length;
    document.getElementById('cnt-rocket').textContent = w.threats.filter(t=>t.type==='rocket').length;
    document.getElementById('cnt-ball').textContent = w.threats.filter(t=>t.type==='ballistic').length;
    document.getElementById('reserve-btn').disabled = !G.hasReserve;
    document.getElementById('overload-banner').classList.toggle('active', G.load >= 92 && !Settings.godMode);
    DISTRICTS.forEach(d => {
        const subs = G.subgroups.filter(s => s.districtId === d.id);
        const el = document.getElementById('power-'+d.id);
        if(el) el.textContent = subs.filter(s=>s.status==='on').reduce((a,s)=>a+s.power,0);
        const shape = document.getElementById('map-'+d.id);
        if(shape){
            const hasDmg = subs.some(s=>s.status==='damaged');
            const hasOff = subs.some(s=>s.status==='off');
            shape.classList.remove('danger','warning');
            if(hasDmg) shape.classList.add('danger');
            else if(hasOff) shape.classList.add('warning');
        }
    });
}

function addEvent(type, text){
    const list = document.getElementById('events-list');
    const t = new Date().toLocaleTimeString('uk-UA',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    list.insertAdjacentHTML('afterbegin',`<div class="event-item ${type}"><span class="event-time">${t}</span> <span class="event-text">${text}</span></div>`);
    while(list.children.length > 8) list.removeChild(list.lastChild);
    consoleLog(`[${type.toUpperCase()}] ${text}`, type === 'alert' ? 'error' : type === 'warning' ? 'warn' : 'info');
}

// ========== GAME LOGIC ==========
function gameTick(){
    if(G.paused || G.gameOver) return;
    
    const speedMod = Settings.gameSpeed / 100;
    const timeAccel = Settings.timeAccel;
    
    for(let tick = 0; tick < timeAccel; tick++){
        G.subgroups.forEach(s => {
            if(s.status === 'on'){
                s.onTime++;
                s.offTime = 0;
                s.heat = Math.min(100, s.heat + 0.4 * (1 - G.coolBonus) * speedMod);
                if(s.heat >= 100 && !Settings.godMode){
                    s.status = 'damaged';
                    G.consumption -= s.power;
                    addEvent('alert', `üî• ${s.districtShort}-${s.num} –ü–ï–†–ï–ì–û–†–Ü–í!`);
                    setTimeout(() => repairSub(s.id), G.repairTime * 1000 * Settings.repairTimeMod / 100);
                }
            } else if(s.status === 'off'){
                s.offTime++;
                s.onTime = 0;
                s.heat = Math.max(0, s.heat - 1.2);
            } else {
                s.heat = Math.max(0, s.heat - 1.5);
            }
        });
        
        G.wave.time -= speedMod;
        if(G.wave.phase === 'prep'){
            if(G.wave.time <= 0) startAttack();
            else if(Math.floor(G.wave.time) === 10 && G.wave.time > 9.5) addEvent('warning', '‚ö†Ô∏è –ê—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ 10—Å!');
        } else {
            if(G.wave.time > 2 && Math.random() < 0.4 * Settings.attackFreq / 100) spawnThreat();
            G.consumption += (6 + G.wave.num * 2) * speedMod;
            if(G.wave.time <= 0 || (G.wave.threats.length === 0 && G.wave.time < 5)) endWave();
        }
        
        updateThreats();
        G.consumption += (Math.floor(Math.random() * 12) - 5) * speedMod;
        G.consumption = Math.max(400, G.consumption);
        
        if(G.hasAuto && G.load >= 92) autoBalance();
        if(G.load >= 100 && !Settings.godMode) gameOver();
    }
    
    renderSubgroups();
    renderOutages();
    renderMood();
    renderThreats();
    updateUI();
}

function startAttack(){
    G.wave.phase = 'attack';
    G.wave.time = 10 + G.wave.num * 2;
    addEvent('alert', `üî• –•–í–ò–õ–Ø ${G.wave.num}!`);
    if(Settings.autopause){
        G.paused = true;
        document.getElementById('pause-btn').textContent = '‚ñ∂';
    }
}

function spawnThreat(){
    const avail = THREATS.filter(t => t.wave <= G.wave.num);
    const tmpl = avail[Math.floor(Math.random() * avail.length)];
    let blocked = false;
    if(tmpl.type === 'shahed' && Math.random() < G.shahedDef + G.globalDef) blocked = true;
    if(tmpl.type === 'rocket' && Math.random() < G.rocketDef + G.globalDef) blocked = true;
    if(tmpl.type === 'ballistic' && Math.random() < G.globalDef) blocked = true;
    if(blocked){ addEvent('success', `üõ°Ô∏è ${tmpl.name} –∑–±–∏—Ç–æ!`); return; }
    const targetId = DISTRICTS[Math.floor(Math.random() * DISTRICTS.length)].id;
    const target = DISTRICTS.find(d => d.id === targetId);
    G.wave.threats.push({ id:Date.now()+Math.random(), ...tmpl, targetId, x:-20, y:Math.random()*180, tx:target.x, ty:target.y, progress:0 });
}

function updateThreats(){
    const layer = document.getElementById('attacks-layer');
    layer.innerHTML = '';
    const toRemove = [];
    G.wave.threats.forEach(t => {
        t.progress += t.speed * (Settings.gameSpeed / 100);
        if(t.progress >= 1){
            toRemove.push(t.id);
            if(t.dmg > 0) hitDistrict(t);
            showExplosion(t.tx, t.ty);
        } else {
            const cx = t.x + (t.tx - t.x) * t.progress;
            const cy = t.y + (t.ty - t.y) * t.progress;
            const path = document.createElementNS('http://www.w3.org/2000/svg','line');
            path.setAttribute('x1',cx); path.setAttribute('y1',cy);
            path.setAttribute('x2',t.tx); path.setAttribute('y2',t.ty);
            path.setAttribute('class','attack-path '+t.type);
            layer.appendChild(path);
            const icon = document.createElementNS('http://www.w3.org/2000/svg','text');
            icon.setAttribute('x',cx); icon.setAttribute('y',cy);
            icon.setAttribute('font-size','14'); icon.setAttribute('text-anchor','middle');
            icon.textContent = t.icon;
            layer.appendChild(icon);
        }
    });
    G.wave.threats = G.wave.threats.filter(t => !toRemove.includes(t.id));
}

function hitDistrict(threat){
    if(Settings.godMode) return;
    const subs = G.subgroups.filter(s => s.districtId === threat.targetId && s.status !== 'damaged');
    let dmg = Math.round(threat.dmg * (1 - G.dmgReduction) * Settings.enemyDmg / 100);
    if(dmg < 1) dmg = 1;
    const toHit = subs.slice(0, Math.min(dmg, subs.length));
    toHit.forEach(s => {
        if(s.status === 'on') G.consumption -= s.power;
        s.status = 'damaged';
        setTimeout(() => repairSub(s.id), G.repairTime * 1000 * Settings.repairTimeMod / 100);
    });
    if(toHit.length > 0){
        const dist = DISTRICTS.find(d => d.id === threat.targetId);
        addEvent('alert', `üí• ${threat.name}‚Üí${dist.short} ${toHit.length}—à–∫–æ–¥–∏`);
    }
}

function repairSub(id){
    const s = G.subgroups.find(x => x.id === id);
    if(s && s.status === 'damaged'){ s.status = 'on'; s.heat = 0; G.consumption += s.power; addEvent('success', `‚úì ${s.districtShort}-${s.num} OK`); }
}

function showExplosion(x, y){
    const section = document.getElementById('map-section');
    const svg = document.getElementById('kyiv-svg');
    const rect = svg.getBoundingClientRect();
    const exp = document.createElement('div');
    exp.className = 'explosion';
    exp.style.left = (x * rect.width / 500) + 'px';
    exp.style.top = (y * rect.height / 180 + 24) + 'px';
    section.appendChild(exp);
    setTimeout(() => exp.remove(), 400);
}

function endWave(){
    G.wave.threats = [];
    document.getElementById('attacks-layer').innerHTML = '';
    const reward = 50 + G.wave.num * 25;
    G.money += reward;
    addEvent('success', `‚úì –•–≤–∏–ª—è ${G.wave.num}! +${reward}‚Ç¥`);
    G.consumption = Math.max(500, G.consumption - 80);
    G.wave.num++;
    G.wave.phase = 'prep';
    G.wave.time = Math.max(25, 45 - G.wave.num * 2);
    if(G.wave.num % 3 === 0) G.day++;
    renderUpgrades();
    if(G.wave.num > 12) victory();
}

function autoBalance(){
    const hot = G.subgroups.filter(s=>s.status==='on').sort((a,b)=>b.heat-a.heat)[0];
    if(hot){ hot.status='off'; G.consumption-=hot.power; addEvent('info',`‚öñÔ∏è –ê–≤—Ç–æ: ${hot.districtShort}-${hot.num} OFF`); }
}

// ========== ACTIONS ==========
function toggleSubgroup(id){
    const s = G.subgroups.find(x => x.id === id);
    if(!s || s.status === 'damaged') return;
    if(s.status === 'on'){ s.status = 'off'; G.consumption -= s.power; }
    else { s.status = 'on'; G.consumption += s.power; }
    renderSubgroups();
}

function enableAll(){
    let c = 0;
    G.subgroups.forEach(s => { if(s.status==='off'){ s.status='on'; G.consumption+=s.power; c++; }});
    if(c) addEvent('info', `‚úì ON ${c} –≥—Ä—É–ø`);
    renderSubgroups();
}

function emergencyOff(){
    const hot = G.subgroups.filter(s=>s.status==='on').sort((a,b)=>b.heat-a.heat).slice(0,5);
    hot.forEach(s => { s.status='off'; G.consumption-=s.power; });
    if(hot.length) addEvent('warning', `‚ö† OFF ${hot.length} –≥–∞—Ä—è—á–∏—Ö`);
    renderSubgroups();
}

function rotateGroups(){
    const on = G.subgroups.filter(s=>s.status==='on').sort((a,b)=>b.heat-a.heat);
    const off = G.subgroups.filter(s=>s.status==='off').sort((a,b)=>b.offTime-a.offTime);
    const n = Math.min(4, on.length, off.length);
    for(let i=0;i<n;i++){
        if(on[i].heat>25||off[i].offTime>25){
            on[i].status='off'; G.consumption-=on[i].power;
            off[i].status='on'; G.consumption+=off[i].power;
        }
    }
    addEvent('info', `üîÑ –†–æ—Ç–∞—Ü—ñ—è ${n} –≥—Ä—É–ø`);
    renderSubgroups();
}

function useReserve(){
    if(!G.hasReserve) return;
    const btn = document.getElementById('reserve-btn');
    if(btn.disabled) return;
    btn.disabled = true;
    G.generation += 300;
    addEvent('success', 'üîã +300MW 15—Å!');
    setTimeout(() => { G.generation -= 300; btn.disabled = false; addEvent('info','üîã –†–µ–∑–µ—Ä–≤ –≤–∏—á–µ—Ä–ø–∞–Ω–æ'); }, 15000);
}

function buyUpgrade(id){
    const ups = [...UPGRADES.infra, ...UPGRADES.defense];
    const u = ups.find(x => x.id === id);
    if(!u || G.boughtUpgrades.has(id) || G.money < u.cost) return;
    G.money -= u.cost;
    G.boughtUpgrades.add(id);
    u.effect();
    addEvent('success', `üîß ${u.name}`);
    renderUpgrades();
    updateUI();
}

function togglePause(){
    G.paused = !G.paused;
    document.getElementById('pause-btn').textContent = G.paused ? '‚ñ∂' : '‚è∏';
}

function gameOver(){
    G.gameOver = true;
    document.getElementById('overlay-title').textContent = '‚ö´ –ë–õ–ï–ö–ê–£–¢';
    document.getElementById('overlay-title').className = 'overlay-title defeat';
    document.getElementById('overlay-stats').innerHTML = `–•–≤–∏–ª—å: ${G.wave.num-1}<br>–ú–∞–∫—Å: ${G.maxLoad}%<br>‚Ç¥${G.money}`;
    document.getElementById('game-overlay').classList.add('active');
    document.getElementById('overload-banner').classList.remove('active');
}

function victory(){
    G.gameOver = true;
    document.getElementById('overlay-title').textContent = 'üèÜ –ü–ï–†–ï–ú–û–ì–ê!';
    document.getElementById('overlay-title').className = 'overlay-title victory';
    document.getElementById('overlay-stats').innerHTML = `12 —Ö–≤–∏–ª—å!<br>–î–µ–Ω—å ${G.day}<br>‚Ç¥${G.money}`;
    document.getElementById('game-overlay').classList.add('active');
}

// ========== INIT ==========
renderMap();
renderSubgroups();
renderUpgrades();
renderOutages();
renderMood();
updateUI();
loadSettings();
addEvent('info', 'üü¢ –°—Ç–∞—Ä—Ç! Ctrl+Shift+D –¥–ª—è –¥–µ–±–∞–≥—É');
setInterval(gameTick, 1000);
</script>
</body>
</html>
